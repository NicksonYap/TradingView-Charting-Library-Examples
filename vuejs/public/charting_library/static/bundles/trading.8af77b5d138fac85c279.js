(window.webpackJsonp=window.webpackJsonp||[]).push([["trading"],{"1rjR":function(t,e,o){"use strict";var r,i;o.d(e,"a",function(){return i}),o("HbRj"),o("YFKU"),r=o("hHwE"),i={get:function(){return this},open:function(t){var e=window.t("Cancel Order"),o="<p>"+window.t("Are you sure you want to cancel order %s?").replace(/%s/,String(t))+"</p>";return Object(r.a)(e,o)},multiple:function(t,e,o){var i,n,s=t;return void 0!==e&&(s+=" ",s+=1===e?window.t("BUY"):window.t("SELL")),i=window.t("Cancel Orders"),n="<p>"+window.t("Are you sure you want to cancel {0} {1} orders?").format(String(o),s)+"</p>",Object(r.a)(i,n)}}},"5XxY":function(t,e,o){"use strict";var r;o.d(e,"a",function(){return r}),o("HbRj"),o("YFKU"),r={show:function(t,e){Promise.all([o.e("dialogs-core"),o.e("create-dialog")]).then(function(r){(0,o("YDhE").createDialog)({title:t,content:e,width:500,type:"modal",draggable:!1,destroyOnClose:!0,closeOnOutsideClick:!1,addClass:"tv-text",actions:[{name:"ok",text:window.t("Ok"),type:"primary",method:"close"}]}).open()}.bind(null,o)).catch(o.oe)}}},"6aj4":function(t,e,o){t.exports={"trading-panel-content":"trading-panel-content-1fMpgHzg","trading-panel-spinner":"trading-panel-spinner-302GKpcG","trading-panel-handle":"trading-panel-handle-31nauMFK"}},"8Wzo":function(t,e,o){"use strict";var r;o.r(e),o.d(e,"StopType",function(){return r}),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(r||(r={}))},"8wgr":function(t,e,o){"use strict";o.r(e),o.d(e,"settingsKeys",function(){return r});var r={ACTIVE_BROKER:"trading.active_broker",FILTER_BROKER:"trading.filter_brokers_by_locale",PROPERTIES:"trading.chart.proterty",QTY:"trading.qty.",BROKERS_QTY:"trading.brokers.qty",PROFIT_VIEW_TYPE:"trading.dom.profitViewType",ORDER_WIDGET_MODE:"trading.orderWidgetMode.",TAKE_PROFIT:"trading.takeprofit.",STOP_LOSS:"trading.stoploss.",ORDER_DURATION:"trading.orderDuration.",TRADING_PANEL_OPENED:"trading.tradingPanelOpened",TRADING_PANEL_ACTIVE_PAGE:"trading.tradingPanelActivePage",PANEL_WIDTH:"trading.panelWidth",PANEL_HEIGHT:"trading.panelHeight",ORDER_PANEL_SETTINGS:"trading.orderPanelSettings",REVIEW_DIALOG_WAS_SHOWED:"trading.reviewDialogShowedOnLogin"}},"9pog":function(t,e,o){"use strict";function r(t){var e,o;if(t<1)return i.NumericFormatter.formatNoE(t);if(e=0,o=+t,isFinite(o))for(;o>=1e3&&o%100==0;)e++,o/=1e3;return o+(e<n.length?n[e]:"e"+3*e)}var i,n;o.r(e),o.d(e,"abbreviatedNumber",function(){return r}),i=o("zXvd"),n=["","K","M","G","T","Y"]},C9TK:function(t,e,o){"use strict";function r(t,e,o,r){return new Promise(function(n){var s=window.t("Reverse {0} position?").format(t),a=r?window.t("Are you sure you want to reverse {positionId} position?{newLineAndBoldText}This will also close all active orders.{endBoldText}"):window.t("Are you sure you want to reverse {positionId} position?"),c="<p>"+a.format({positionId:t,newLineAndBoldText:"<br><b>",endBoldText:"</b>"})+"</p>",u=window.t("Reverse position"),d=window.t("Cancel");Object(i.a)(s,c,u,d).then(function(t){return!0===t?o():n(!1)}).then(function(){n(!0)
}).catch(function(t){var o,r="";null!==t&&"object"==typeof t&&t.message?r=t.message:"string"==typeof t&&(r=t),o=window.t("Failed to reverse position"),e(o,r),n(!1)})})}var i;o.d(e,"a",function(){return r}),o("HbRj"),o("YFKU"),i=o("hHwE")},E9hm:function(t,e,o){"use strict";function r(t){return Object.assign({},i,t)}o.d(e,"b",function(){return i}),o.d(e,"a",function(){return r});var i={isSuspended:!1,supportDemoLiveSwitcher:!0,supportEditAmount:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyOrder:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0}},End0:function(t,e,o){"use strict";function r(t){var e,o,i,n;if("object"!=typeof t||null==t||"number"==typeof t.nodeType)e=t;else if(Array.isArray(t))for(e=[],o=0,i=t.length;o<i;o++)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=r(t[o]));else for(n in e={},t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=r(t[n]));return e}function i(){n(ot.filter(function(t){return!!t.soundForAlerts}).map(function(t){return t.path}))}function n(t){var e,o;Object(Z.isOnMobileAppPage)("any")||t&&/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(window.navigator.userAgent)&&(Array.isArray(t)||(t=[t]),0!==(t=t.filter(function(t){var e=it(t);return!(!e||!e.el.load||e._mobilePreloadActive)&&(e._mobilePreloadActive=!0,!0)})).length?(e=function(){var r=[];Array.isArray(t)&&t.forEach(function(t){var e,o=it(t);o.el.load(),e=o.play().catch(function(t){if("AbortError"!==t.name)throw tt.logError('enableForMobile for "'+o.el.src+'" preload error: - '+t.message),t}),o.el.pause(),r.push(e)}),Promise.all(r).then(function(){tt.logNormal("enableForMobile sounds initialized")}),o.forEach(function(t){document.removeEventListener(t,e,!0)})},(o=["click","touchend","keydown"]).forEach(function(t){document.addEventListener(t,e,!0)})):tt.logNormal("enableForMobile no sounds passed"))}function s(t,e){return t.enabled.value()&&(e.soundName=t.name),e}function a(t){return 6===t||3===t}var c,u,d,l,p,h,f,_,b,m,y,g,v,k,P,w,O,C,S,B,T,E,j,I,D,A,M,N,U,L,R,x,F,V,q,W,Q,K,H,z,Y,G,J,X,Z,tt,et,ot,rt,it,nt,st,at,ct,ut,dt,lt,pt,ht,ft,_t,bt;o.r(e),c=o("mrSG"),o("P5fv"),o("YFKU"),o("X8qL"),u=o("Eyy1"),d=o("ivNn"),l=o("Hgre"),p=o("OekH"),h=o("8wgr"),f=o("U/Is"),_=o("aIyQ"),b=o.n(_),m=o("uOxu"),y=o("d13A"),g=Object(m.getLogger)("Trading.RealtimeProvider"),v=function(){function t(t){this._results={},this._getter=t}return t.prototype.get=function(t){return this._results[t]||(this._results[t]=this._getter(t)),this._results[t]},t}(),k=function(){function t(t,e,o,r,i){var n=this;this._stopped=!1,this._subscribed=!1,this._provider=null,this._formatters=null,this._symbol=t,this._type=i,this._callback=e,this._providersCache=o,this._formattersCache=r,"Realtime"===this._type?this._handler=function(t,o){n._stopped||e(t,o,n._formatters)}:this._handler=function(t,o){n._stopped||e(t,o)},this._start().catch(function(t){})}return t.prototype.symbol=function(){return this._symbol},
t.prototype.type=function(){return this._type},t.prototype.callback=function(){return this._callback},t.prototype.destroy=function(){this._ensureNotStopped(),this._subscribed&&("Realtime"===this._type?Object(u.ensureNotNull)(this._provider).unsubscribeRealtime(this._symbol,this._handler):Object(u.ensureNotNull)(this._provider).unsubscribeDOME(this._symbol,this._handler)),this._stopped=!0},t.prototype._start=function(){return Object(c.__awaiter)(this,void 0,void 0,function(){var t,e;return Object(c.__generator)(this,function(o){switch(o.label){case 0:return t=this,[4,this._providersCache.get(this._symbol)];case 1:return t._provider=o.sent(),this._ensureNotStopped(),e=this,[4,this._formattersCache.get(this._symbol)];case 2:return e._formatters=o.sent(),Object(u.ensure)(this._formatters),this._ensureNotStopped(),this._subscribed=!0,"Realtime"===this._type?this._provider.subscribeRealtime(this._symbol,this._handler):this._provider.subscribeDOME(this._symbol,this._handler),[2]}})})},t.prototype._ensureNotStopped=function(){Object(u.assert)(!this._stopped,"Should not be stopped")},t}(),P=function(){function t(t,e,o,r){this.onStatusChanged=new b.a,this._subscriptions=[],this._currentBroker=null,this._activeBrokerGetter=t,this._suggestedQty=r,this._createCaches(),e.subscribe(this,this._onBrokerChanged),o.subscribe(this,this._onBrokerChanged),this._tvProvider=new f.a("RealtimeProvider"),this._onBrokerChanged()}return t.prototype.isTradable=function(t){return this._tradableCache.get(t)},t.prototype.subscribeRealtime=function(t,e){this._subscriptions.some(function(o){return o.symbol()===t&&o.callback()===e&&"Realtime"===o.type()})||this._subscriptions.push(new k(t,e,this._providersCache,this._formattersCache,"Realtime"))},t.prototype.unsubscribeRealtime=function(t,e){var o=this._subscriptions.findIndex(function(o){return o.symbol()===t&&o.callback()===e&&"Realtime"===o.type()});-1!==o?(this._subscriptions[o].destroy(),this._subscriptions.splice(o,1)):g.logWarn("Subscription not found")},t.prototype.subscribeDOME=function(t,e){this._subscriptions.some(function(o){return o.symbol()===t&&o.callback()===e&&"Dome"===o.type()})||this._subscriptions.push(new k(t,e,this._providersCache,this._formattersCache,"Dome"))},t.prototype.unsubscribeDOME=function(t,e){var o=this._subscriptions.findIndex(function(o){return o.symbol()===t&&o.callback()===e&&"Dome"===o.type()});-1!==o?(this._subscriptions[o].destroy(),this._subscriptions.splice(o,1)):g.logWarn("Subscription not found")},t.prototype.formatter=function(t){return this._formattersCache.get(t).then(function(t){return t.formatter})},t.prototype.spreadFormatter=function(t){return this._formattersCache.get(t).then(function(t){return t.spreadFormatter})},t.prototype.quantityFormatter=function(t){return this._formattersCache.get(t).then(function(t){return t.quantityFormatter})},t.prototype.symbolInfo=function(t){var e,o=this;return t?this._providersCache.get(t).then(function(e){return e!==o._tvProvider?e.symbolInfo(t).then(function(e){return e||o._tvProvider.symbolInfo(t)
}).catch(function(e){return o._tvProvider.symbolInfo(t)}):o._tvProvider.symbolInfo(t)}):(e={minTick:NaN,qty:{min:NaN,max:NaN,step:NaN},pipValue:NaN,pipSize:NaN,description:"no symbol"},Promise.resolve(e))},t.prototype.quotesSnapshot=function(t){return this._providersCache.get(t).then(function(e){return e.quotesSnapshot(t)})},t.prototype.activeBroker=function(){return null!==this._currentBroker&&this._currentBroker!==this._tvProvider?this._currentBroker:null},t.prototype._isTradable=function(t){if(null===this._currentBroker||this._currentBroker===this._tvProvider)return Promise.resolve({tradable:!1});try{return Object(y.makeTimeLimited)(this._currentBroker.isTradable(t),6e4,"isTradable Promise Timeout").catch(function(){return Promise.resolve({tradable:!1})})}catch(t){return Promise.resolve({tradable:!1})}},t.prototype._haveRealtime=function(t){return this._tradableCache.get(t)||Promise.resolve(null===this._currentBroker)},t.prototype._onBrokerChanged=function(){var t,e=this,o=this._activeBrokerGetter(),r=this._currentBroker,i=o&&1===o.connectionStatus()?o:null;r!==i&&(this._createCaches(),t=this._subscriptions.map(function(t){return{symbol:t.symbol(),callback:t.callback(),type:t.type()}}),this._unsubscribeAll(),this._currentBroker=i,this._subscribeAll(t),this._allSymbols().forEach(function(t){e._suggestedQty.changed.fire(t)}),this.onStatusChanged.fire())},t.prototype._allSymbols=function(){var t=new Set;return this._subscriptions.forEach(function(e){return t.add(e.symbol())}),Array.from(t)},t.prototype._createCaches=function(){var t=this;this._providersCache=new v(function(e){return t._provider(e)}),this._tradableCache=new v(function(e){return t._isTradable(e)}),this._formattersCache=new v(function(e){return t._providersCache.get(e).then(function(t){return Promise.all([t.formatter(e,!1),t.spreadFormatter(e),t.quantityFormatter(e)])}).then(function(t){return{formatter:t[0],spreadFormatter:t[1],quantityFormatter:t[2]}})})},t.prototype._provider=function(t){var e=this;return this._haveRealtime(t).then(function(t){return t.tradable&&e._currentBroker&&1===e._currentBroker.connectionStatus()?e._currentBroker:e._tvProvider})},t.prototype._unsubscribeAll=function(){this._subscriptions.forEach(function(t){t.destroy()}),this._subscriptions=[]},t.prototype._subscribeAll=function(t){var e=this;t.forEach(function(t){e._subscriptions.push(new k(t.symbol,t.callback,e._providersCache,e._formattersCache,t.type))})},t}(),w=o("2TBc"),O=function(t){function e(e){return t.call(this,e)||this}return Object(c.__extends)(e,t),e.prototype.trackOrderPlaced=function(t){this._trackOrderEvent("Placed",t)},e.prototype.startService=function(){Object(u.ensure)(this.activeBroker()).orderUpdate.subscribe(this,this._orderUpdate),this._trackStat("Broker Connected")},e.prototype.stopService=function(){Object(u.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)},e.prototype._orderUpdate=function(t,e){
e||(5===t.status?this._trackOrderEvent("Rejected"):2===t.status?this._trackOrderEvent("Executed",t):1===t.status&&this._trackOrderEvent("Canceled"))},e.prototype._trackOrderEvent=function(t,e){var o=this,r=this.activeBroker();e&&r?r.symbolInfo(e.symbol).then(function(r){var i=e.qty*(r.lotSize||1);o._trackStat("Order "+t,{amount:i,instrumentType:r.type})}):this._trackStat("Order "+t)},e.prototype._trackStat=function(t,e){var o=this.activeBroker();if(!o)throw new Error("no active broker");o.metainfo().id},e}(w.a),C=o("Vdly"),S=o("4qhP"),B=o("9pog"),T=o("1AAW"),E=o("hY0g"),j=o.n(E),I=o("PT1i"),D=o("ZbcA"),A=o("PC8g"),M=o("QloM"),N=function(){function t(t){this._chartWidgetCollection=t}return t.prototype.proSymbol=function(){return I.linking.proSymbol.value()},t.prototype.showTradingProperties=function(){this._chartWidgetCollection.activeChartWidget.value().showGeneralChartProperties(M.TabNames.trading)},t.prototype.showNotification=function(t,e,o,r){var i="";"string"==typeof e&&(i=e),D.tvToasts.toast({text:i,time:r,title:t,type:o})},t.prototype.showMaintenance=function(t){0},t.prototype.trackEvent=function(t,e,o){Object(A.trackEvent)(t,e,o)},t.prototype.showReplayConfirmationDialog=function(){return Promise.resolve()},t.prototype.reconnectChartApi=function(t){0},t}(),U=o("Kxc7"),L=o("8Wzo"),R=o("Pw9B"),x=o("C9TK"),F=o("1rjR"),V=o("QBLL"),o("5XxY"),q=Object(m.getLogger)("Trading.BrokerCommandsUI"),W=function(){function t(t,e,o,r,i){this._activeBroker=t,this._guiAccessor=e,this._orderViewController=r,this._showErrorNotification=i,this._noConfirmEnabled=o}return t.prototype.placeOrder=function(t,e,o){return Object(c.__awaiter)(this,void 0,void 0,function(){var r,i,n,s,a,u,d,l=this;return Object(c.__generator)(this,function(c){switch(c.label){case 0:0,this._makeSureBrokerIsConnected(),r=1===t.type?1:2,i=e&&this._noConfirmEnabled.value(),n=this._guiAccessor&&i?this._guiAccessor.showReplayConfirmationDialog():Promise.resolve(!1),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,n];case 2:return c.sent(),[3,4];case 3:return c.sent(),Promise.resolve(!1),[3,4];case 4:return[4,this._activeBroker.isTradable(t.symbol)];case 5:return s=c.sent(),i&&s.tradable?(a=this._activeBroker.metainfo().durations,void 0===t.duration&&void 0!==a&&a.length>0&&(u=a.find(function(t){return"default"in t}),t.duration={type:(u||a[0]).value}),[2,this._activeBroker.placeOrder(t)]):(d=this._activeBroker.metainfo()).customUI&&void 0!==d.customUI.showOrderDialog?[2,d.customUI.showOrderDialog(t,r)]:[2,this._orderViewController().then(function(e){return l._activeBroker?e.showOrderView(l._activeBroker,t,r,o):Promise.reject("Broker connection adapter is null")})]}})})},t.prototype.modifyOrder=function(t,e,o,r){return Object(c.__awaiter)(this,void 0,void 0,function(){var i,n,s,a,u,d,l,p,h,f,_,b=this;return Object(c.__generator)(this,function(c){switch(c.label){case 0:return this._makeSureBrokerIsConnected(),t.flags&&t.flags.trailingStop?(q.logError("Attempt to modify trailing stop loss order"+t.id),
this._showErrorNotification(window.t("Cannot Modify Order"),window.t("Trailing Stops cannot be modified")),[2,Promise.resolve(!1)]):[4,this._activeBroker.symbolInfo(t.symbol)];case 1:if(i=c.sent(),t.limitPrice=void 0!==i.limitPriceStep&&void 0!==t.limitPrice?Object(S.roundToStepByPriceTypeAndSide)(t.limitPrice,i.limitPriceStep,1,t.side):t.limitPrice,t.stopPrice=void 0!==i.stopPriceStep&&void 0!==t.stopPrice?Object(S.roundToStepByPriceTypeAndSide)(t.stopPrice,i.stopPriceStep,2,t.side):t.stopPrice,n=t.limitPrice,s=t.stopPrice,a=t.stopType,u=e&&this._noConfirmEnabled.value(),d=o||(1===t.type?1:2),!t.parentId)return[3,6];l=this._activeBroker.orderById.bind(this._activeBroker),2===t.parentType&&(l=this._activeBroker.positionById.bind(this._activeBroker)),3===t.parentType&&(l=this._activeBroker.tradeById.bind(this._activeBroker)),p=void 0,c.label=2;case 2:return c.trys.push([2,4,,5]),[4,l(t.parentId)];case 3:return p=c.sent(),[3,5];case 4:return c.sent(),p=void 0,[3,5];case 5:if(p){if(d=o||(1===t.type?3:4),h={takeProfit:n},a===L.StopType.TrailingStop?h.trailingStopPips=t.trailingStopPips:h.stopLoss=s,u&&(h.takeProfit=h.takeProfit||p.takeProfit,h.stopLoss=h.stopLoss||p.stopLoss,h.trailingStopPips=h.trailingStopPips||p.trailingStopPips),3===t.parentType)return u?[2,this._activeBroker.editTradeBrackets(p.id,h)]:[2,this._showTradeDialog(p,h,d)];if(2===t.parentType&&t.qty===Math.abs(p.qty))return u?[2,this._activeBroker.editPositionBrackets(p.id,h)]:[2,this._showPositionDialog(p,h,d)];f=p,Object(S.isOrderActive)(f.status)&&(U.enabled("always_pass_called_order_to_modify")||(t=Object.assign({},f),n&&(t.takeProfit=n),s&&(a===L.StopType.TrailingStop?t.trailingStopPips=h.trailingStopPips||t.trailingStopPips:t.stopLoss=s)))}c.label=6;case 6:return u?[2,this._activeBroker.modifyOrder(t)]:(_=this._activeBroker.metainfo()).customUI&&void 0!==_.customUI.showOrderDialog?[2,_.customUI.showOrderDialog(t,d)]:[2,this._orderViewController().then(function(e){return b._activeBroker?e.showOrderView(b._activeBroker,t,d,r):Promise.reject("Broker connection adapter is null")})]}})})},t.prototype.closePosition=function(t){if(this._makeSureBrokerIsConnected(),this._noConfirmEnabled.value())return this._activeBroker.closePosition(t);var e=this._activeBroker.closePosition.bind(this._activeBroker,t);return Object(R.a)(t,this._showErrorNotification,e,this._activeBroker.config.closePositionCancelsOrders)},t.prototype.closeTrade=function(t){if(this._makeSureBrokerIsConnected(),Object(u.assert)(!!this._activeBroker.config.supportTrades,"Broker doesn`t support trades"),this._noConfirmEnabled.value())return this._activeBroker.closeTrade(t);var e=this._activeBroker.closeTrade.bind(this._activeBroker,t);return Object(R.a)(t,this._showErrorNotification,e)},t.prototype.editPositionBrackets=function(t,e,o,r){var i=this;return this._makeSureBrokerIsConnected(),Object(u.assert)(!!this._activeBroker.config.supportPositionBrackets,"Broker doesn`t support brackets on positions"),
r?Object(u.ensureDefined)(this._activeBroker.editPositionBrackets)(t,e):this._activeBroker.positionById(t).then(function(t){return i._activeBroker?i._showPositionDialog(Object(u.ensureDefined)(t),e,o):Promise.reject("Broker connection adapter is null")})},t.prototype.editTradeBrackets=function(t,e,o,r){var i=this;return void 0===e&&(e={}),r&&this._noConfirmEnabled.value()?this._activeBroker.editTradeBrackets(t):this._activeBroker.tradeById(t).then(function(t){if(!i._activeBroker)return Promise.reject("Broker connection adapter is null");var r=Object(u.ensureDefined)(t);return i._showTradeDialog(r,e,o)})},t.prototype.reversePosition=function(t){var e=this;return this._makeSureBrokerIsConnected(),this._activeBroker.metainfo().configFlags.supportMultiposition&&!this._activeBroker.config.supportNativeReversePosition?Promise.reject("Cannot reverse position on multiposition acount"):this._noConfirmEnabled.value()?this._activeBroker.reversePosition(t):this._activeBroker.positionById(t).then(function(o){if(!e._activeBroker)return Promise.reject("Broker connection adapter is null");var r=e._activeBroker.reversePosition.bind(e._activeBroker,t);return Object(x.a)(t,e._showErrorNotification,r,e._activeBroker.config.closePositionCancelsOrders)})},t.prototype.cancelOrder=function(t){return Object(c.__awaiter)(this,void 0,void 0,function(){var e,o,r,i,n;return Object(c.__generator)(this,function(s){switch(s.label){case 0:return this._makeSureBrokerIsConnected(),this._noConfirmEnabled.value()?[2,this._activeBroker.cancelOrder(t)]:[3,1];case 1:return[4,this._activeBroker.orderById(t)];case 2:return e=s.sent(),o=this._activeBroker.cancelOrder.bind(this._activeBroker,t),e?(r=e.refNumber||e.referenceNumber||e.id,e.parentId?2!==e.parentType?[3,4]:[4,this._activeBroker.orders()]:[3,5]):[3,6];case 3:return i=s.sent(),n=i.filter(function(t){return t.refNumber===e.refNumber}),this._activeBroker.metainfo().configFlags.cancellingOnePositionBracketsCancelsOther&&n.length>1?[2,this._showCancelMultipleBracketsDialog(r,o)]:[2,this._showCancelBracketsDialog(r,o)];case 4:if(!this._activeBroker.metainfo().configFlags.cancellingBracketCancelsParentOrder)return[2,this._showCancelBracketsDialog(r,o)];s.label=5;case 5:return[2,this._showCancelOrderDialog(r,o)];case 6:return[2,Promise.reject("Failed to find order")]}})})},t.prototype.cancelOrders=function(t,e){var o=this;return this._makeSureBrokerIsConnected(),this._activeBroker.orders().then(function(r){var i,n,s;return o._activeBroker?(i=r.filter(function(o){return o.symbol===t&&(!e||o.side===e)&&function(t){return 4===t.status||3===t.status||6===t.status}(o)})).length?1===i.length?o.cancelOrder(i[0].id):(n=i.map(function(t){return t.id}),o._noConfirmEnabled.value()?o._activeBroker.cancelOrders(t,e,n):(s=o._activeBroker.cancelOrders.bind(o._activeBroker),o._showCancelMultipleOrdersDialog(t,e,n,s))):Promise.resolve(!1):Promise.reject("Broker connection adapter is null")})},t.prototype._makeSureBrokerIsConnected=function(){
Object(u.assert)(1===this._activeBroker.connectionStatus(),"Broker is not connected")},t.prototype._showPositionDialog=function(t,e,o){return void 0===e&&(e={}),Object(c.__awaiter)(this,void 0,void 0,function(){var r,i,n,s=this;return Object(c.__generator)(this,function(a){switch(a.label){case 0:return[4,this._activeBroker.isTradable(t.symbol)];case 1:return(r=a.sent()).tradable?(n=this._activeBroker.metainfo()).customUI&&void 0!==n.customUI.showPositionDialog?[2,n.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},o)]:[2,this._orderViewController().then(function(r){return s._activeBroker?r.showPositionView(s._activeBroker,t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},o||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")})]:(i=void 0!==r.reason?r.reason:window.t("Symbol {symbol} cannot be traded through {broker}.").format({symbol:t.symbol,broker:this._activeBroker.metainfo().title}),this._showErrorNotification(window.t("Cannot protect position"),i),[2,Promise.resolve(!1)])}})})},t.prototype._showTradeDialog=function(t,e,o){var r,i=this;return void 0===e&&(e={}),(r=this._activeBroker.metainfo()).customUI&&void 0!==r.customUI.showPositionDialog?r.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},o):this._orderViewController().then(function(r){return i._activeBroker?r.showTradeView(i._activeBroker,t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},o||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")})},t.prototype._showCancelOrderDialog=function(t,e){return F.a.get().open(t).then(function(o){return o?e(t):Promise.resolve(!1)})},t.prototype._showCancelMultipleOrdersDialog=function(t,e,o,r){var i=o.length;return F.a.get().multiple(t,e,i).then(function(i){return i?r(t,e,o):Promise.resolve(!1)})},t.prototype._showCancelBracketsDialog=function(t,e){return V.a.get().open(t).then(function(o){return o?e(t):Promise.resolve(!1)})},t.prototype._showCancelMultipleBracketsDialog=function(t,e){return V.a.get().multiple(t).then(function(o){return o?e(t):Promise.resolve(!1)})},t}(),Q=function(){function t(t,e){var o=this;this._domePanel=null,this._resizerBridge=t,this._close=function(){o.unmount(),e()}}return t.prototype.mount=function(){return this._getDomPanel().then(function(t){t.setVisibility(!0)})},t.prototype.unmount=function(){this._getDomPanel().then(function(t){t.setVisibility(!1)})},t.prototype._getDomPanel=function(){var t=this;return null!==this._domePanel?Promise.resolve(this._domePanel):Promise.all([o.e(22),o.e(68),o.e(75),o.e("dome-panel")]).then(o.t.bind(null,"SScx",7)).then(function(e){var o=new e.DomePanel({resizerBridge:t._resizerBridge});return o.setCloseHandler(t._close),t._domePanel=o,o})},t}(),K=function(){function t(){}return t.prototype.mount=function(){return Promise.resolve()},t.prototype.unmount=function(){},t}(),H=o("vOQ2"),z=o("/BH3"),Y=o("6aj4"),G=function(){
function t(t){var e=this;this.isOpened=new j.a(!1),this.isAvailable=new j.a(!0),this.activePage=new j.a(H.d.DomPanel),this.isLoading=new j.a(!1),this._pages={},this._width=H.c,this._onLayoutResizeHandleMousedown=function(t){var o,r,i,n;!t.defaultPrevented&&t.cancelable&&(t.preventDefault(),o=Math.max(e._resizerBridge.width.value(),0),r="touches"in t?t.touches[0].clientX:t.clientX,i=function(t){var i,n;t.preventDefault(),i="touches"in t?t.touches[0].clientX:t.clientX,(n=o-(i-r))<H.c?n=H.c:n>H.a&&(n=H.a),e._requestWidth(n)},n=function(){document.removeEventListener("mousemove",i),document.removeEventListener("touchmove",i),document.removeEventListener("mouseup",n),document.removeEventListener("touchend",n),C.setValue(h.settingsKeys.PANEL_WIDTH,e._width)},document.addEventListener("mousemove",i),document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("mouseup",n),document.addEventListener("touchend",n,{passive:!1}))},this._resizerBridge=t,this._rootContainer=this._resizerBridge.container.value(),this.container=document.createElement("div"),this.container.classList.add(Y["trading-panel-content"],"trading-panel-content"),this._rootContainer.appendChild(this.container),this._addSpinner(),this._addResizeHandler(),this._updateAvailable({width:this._resizerBridge.availWidth.value(),height:this._resizerBridge.availHeight.value()}),Object(T.a)(function(t,e){return{width:t,height:e}},this._resizerBridge.availWidth,this._resizerBridge.availHeight).subscribe(this._updateAvailable.bind(this)),this.isLoading.subscribe(this._setLoading.bind(this)),this._rootContainer.style.overflow=this.isOpened.value()?"":"hidden"}return t.prototype.addPage=function(t,e){this._pages[t]=e},t.prototype.isPageOpened=function(t){return this.isOpened.value()&&this.activePage.value()===t},t.prototype.setPage=function(t){this.isOpened.value()&&this.activePage.value()!==t&&this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this.activePage.setValue(t),C.setValue(h.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,t)},t.prototype.openPage=function(t){this.setPage(t),this.open()},t.prototype.open=function(){this._pages[this.activePage.value()]&&(this._togglePanel(!0),this.isOpened.setValue(!0),this._pages[this.activePage.value()].mount())},t.prototype.close=function(){this.isOpened.setValue(!1),this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this._togglePanel(!1)},t.prototype._setLoading=function(t){t?this._rootContainer.appendChild(this._spinnerContainer):this._rootContainer.contains(this._spinnerContainer)&&this._rootContainer.removeChild(this._spinnerContainer)},t.prototype._addSpinner=function(){var t=this;this._spinnerContainer=document.createElement("div"),this._spinnerContainer.classList.add(Y["trading-panel-spinner"]),Promise.all([o.e("react"),o.e("spinner-renderer")]).then(o.bind(null,"lG9f")).then(function(e){e.render(t._spinnerContainer)})},t.prototype._addResizeHandler=function(){this._handle=document.createElement("div"),
this._handle.classList.add(Y["trading-panel-handle"]),this._rootContainer.appendChild(this._handle),this._handle.addEventListener("mousedown",this._onLayoutResizeHandleMousedown,{passive:!1}),this._handle.addEventListener("touchstart",this._onLayoutResizeHandleMousedown,{passive:!1}),this._width=C.getInt(h.settingsKeys.PANEL_WIDTH)||H.c},t.prototype._togglePanel=function(t){this._resizerBridge.negotiateWidth(t?this._width:0),this._resizerBridge.negotiateHeight(t?H.b:0),this._rootContainer.style.overflow=t?"":"hidden",C.setValue(h.settingsKeys.TRADING_PANEL_OPENED,t)},t.prototype._updateAvailable=function(t){this.isAvailable.setValue(t.width>=H.c&&t.height>=H.b)},t.prototype._requestWidth=function(t){this._canOpen(t)&&this._resizerBridge.width.value()!==t&&(this._resizerBridge.negotiateWidth([{min:H.c,max:t}]),this._width=t)},t.prototype._canOpen=function(t){return t+z.tabsWidth<=this._resizerBridge.availWidth.value()},t}(),J=o("lxNp"),o("HbRj"),X=o("9XXR"),Z=o("qFKp"),tt=Object(m.getLogger)("Lib.Sound",{color:"#dea433"}),et={sound:"notification/notification",alert:"alert/fired"},ot=[{title:window.t("Alarm Clock"),path:"alert/alarm_clock",soundForAlerts:!0}],rt={},it=function(t){var e,o,r;return t in rt?rt[t]:(tt.logNormal("requested sound  "+t+" not cached, building a new audio element"),e=Object(Z.wrapUrl)("/static/sounds/"+t+".mp3"),o=new Audio(e),r={el:o,playing:new j.a(!1),play:function(e){return void 0===e&&(e=0),r.playing.value()?(tt.logNormal("sound already playing"),Promise.reject("already playing")):(r.playing.setValue(!0),new Promise(function(o,i){var n=e>0,s=function(){(function(t){try{tt.logNormal('"'+t.el.src+'" triggering html5 play method, readyState - '+t.el.readyState+"; muted - "+t.el.muted+"; volume - "+t.el.volume+"; currentTime - "+t.el.currentTime);var e=t.el.play();return e||(e=Promise.resolve()),e}catch(e){return tt.logError('play method for "'+t.el.src+'" catch error - '+e.message),Promise.reject(e)}})(r).catch(function(e){tt.logNormal('stop counting sound "'+t+'"; as playing due to an error: '+e.message),r.stop(),i(e)})};r._onEnded=function(){n?s():(r.stop(),o())},r.el.addEventListener("ended",r._onEnded),n&&setTimeout(function(){tt.logNormal('"'+t+'" repeat timeout - '+e+"s off"),n=!1},1e3*e),s()}))},stop:function(){r.el.pause(),r.playing.setValue(!1),r._onEnded&&r.el.removeEventListener("ended",r._onEnded)}},rt[t]=r,["canplaythrough","error"].forEach(function(e){o.addEventListener(e,function(){tt.logNormal('for sound "'+t+'", event - '+e+" is fired")},!1)}),tt.logNormal("canPlayType - "+o.canPlayType("audio/mp3")),rt[t])},n(ot.filter(function(t){return!!t.common}).map(function(t){return t.path})),nt=o("JOqt"),st=o("IWXC"),at=["qty","stopPrice","limitPrice","filledQty","status"],ct=function(t){function e(e){var o=t.call(this,e)||this;return o._orders=[],o._playSound=Object(nt.debounce)(o._playSoundImpl,50),i(),o}return Object(c.__extends)(e,t),e.prototype.startService=function(){var t=this,e=Object(u.ensure)(this.activeBroker());e.orders().then(function(e){return t._orders=r(e)}),
e.orderUpdate.subscribe(this,this._orderUpdate)},e.prototype.stopService=function(){Object(u.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)},e.prototype._showNotification=function(t,e,o){U.enabled("trading_notifications")&&("error"===o?this.trading().showErrorNotification(t,e):this.trading().showSuccessNotification(t,e))},e.prototype._formatter=function(t){return Object(st.getQuoteSessionInstance)("simple").formatter(t)},e.prototype._checkOrderModified=function(t,e){var o=this.activeBroker(),r=o&&o.metainfo().customNotificationFields||[],i=at.concat(r),n=!1;return i.forEach(function(o){n||function t(e,o,r){var i,n;return void 0!==e&&void 0!==o&&(-1!==(i=r.indexOf("."))?t(e[n=r.substring(0,i)],o[n],r.substring(i+1)):e[r]===o[r])}(t,e,o)||(n=!0)}),n},e.prototype._generateNotificationsInfo=function(t,e){var o=[],r=t.statusMessage?": "+t.statusMessage:"",i=(1===t.side?window.t("Bought"):window.t("Sold")).toUpperCase(),n=this.trading().orderExecutedSoundParams;return e?(this._checkOrderModified(t,e)&&(1===t.status?o.push({text:window.t("cancelled")}):6===t.status&&e.filledQty!==t.filledQty?o.push(s(n,{side:i,text:window.t("executed partially")})):a(t.status)?o.push({text:window.t("modified")}):2===t.status&&o.push(s(n,{side:i,text:window.t("executed")}))),$.extend(e,t)):a(t.status)?(this._orders.push(t),o.push({text:window.t("placed")}),this.trading().trackEvent("","Order placed symbol",t.symbol)):5===t.status?(this._orders.push(t),o.push({text:window.t("rejected")+r,type:"error"})):2===t.status&&(this._orders.push(t),o.push({text:window.t("placed")},s(n,{side:i,text:window.t("executed"),emptyOrderType:!0})),this.trading().trackEvent("","Order placed symbol",t.symbol)),o},e.prototype._orderUpdate=function(t,e){var o,i=this,n=r(t),s=this._orders.find(function(t){return t.id===n.id});e?void 0===s&&this._orders.push(n):s&&S.isFinalOrderStatus(s.status)||0!==(o=this._generateNotificationsInfo(n,s)).length&&this._formatter(n.symbol).then(function(t){var e,r,s=S.sideToText(n.side,!0),a="",c="",u=n.qty;switch(n.type){case 2:a=n.avgPrice?" ("+S.orderTypeToText(n.type)+")":"",c=n.avgPrice?t.format(n.avgPrice):S.orderTypeToText(n.type);break;case 4:a=" "+window.t("(Limit) after {0} (Stop) crossed").format(t.format(n.stopPrice)),c=t.format(n.avgPrice||n.limitPrice);break;default:a=" ("+S.orderTypeToText(n.type)+")",c=t.format(n.avgPrice||n.limitPrice||n.stopPrice)}n.hasOwnProperty("filledQty")&&void 0!==n.filledQty&&n.filledQty>0&&(u=n.filledQty),e=Object(X.splitThousands)(Math.abs(u))+" "+(n.brokerSymbol||n.symbol)+" "+window.t("at")+" "+c,r=void 0!==n.message?""+n.message.text.charAt(0).toUpperCase()+n.message.text.substr(1):"",o.forEach(function(t){var o=t.side,c=t.text,u=t.type,d=t.emptyOrderType,l=t.soundName,p=window.t("Order")+" "+n.id+" "+c,h=(o||s)+" "+e+" "+(d?"":a)+"<br>"+r;void 0!==l&&i._playSound(l),i._showNotification(p,h,u)})})},e.prototype._playSoundImpl=function(t){var e,o,r=this;if(this._playingSound){if(this._playingSound===t)return;!function(t){
if(!Object(Z.isOnMobileAppPage)("any")){var e=[];t?e.push(it(t)):e=Object.values(rt),e.forEach(function(t){t.stop()})}}(this._playingSound)}this._playingSound=t,void 0===(e=t)&&(e=et.sound),Object(Z.isOnMobileAppPage)("any")?Promise.resolve():(tt.logNormal('Sound play attempt for "'+e+'" duration-'+o+"s;"),it(e).play(o)),function(t,e){Object(Z.isOnMobileAppPage)("any")||it(t).playing.subscribe(function(t){t||e()},{once:!0})}(t,function(){delete r._playingSound})},e}(w.a),ut=o("pJ/4"),dt=o.n(ut),lt=o("MXV9"),o.d(e,"Trading",function(){return bt}),ht=Object(m.getLogger)("Trading.Core"),(pt={})[1]="Connected",pt[2]="Connecting",pt[3]="Disconnected",pt[4]="Error",ft=pt,_t={enabled:new j.a(!1),name:"alert/alarm_clock"},bt=function(){function t(t){var e,r,i,n,s=this;this.accountType=new j.a,this.onBrokerChange=new b.a,this.onBrokerLoading=new b.a,this.onConnectionStatusChange=new b.a,this.onNewNotification=new b.a,this.onNeedSelectBroker=new b.a,this.onNotificationsChanged=new b.a,this.hideFloatingPanel=new j.a,this.noConfirmEnabled=new j.a,this.showOnlyRejectionNotifications=new j.a,this.showPricesWithZeroVolume=new j.a,this.orderExecutedSoundParams=_t,this.tradingPanel=null,this._activeBroker=null,this._orderViewController=null,this._orderControllerPromise=null,this._brokerCommandsUI=null,this._offlineListener=this._offlineHandler.bind(this),this._onlineListener=this._onlineHandler.bind(this),this._notifications=[],this._account=null,this._domPanelVisibility=new j.a(!1),this._orderPanelVisibility=new j.a(!1),this._switchingBroker=!1,this._accountVerificationPromise=null,this._chartWidgetCollection=null,this._updateAccountId=function(t){s._account=t.id,s.onNotificationsChanged.fire(s.getNotifications())},this._resizerBridge=t,this._realtimeProvider=new P(function(){return s.activeBroker()},this.onBrokerChange,this.onConnectionStatusChange,this.suggestedQty()),this._tradingStat=new O(this),this._loginDialogRenderer=Promise.all([o.e("react"),o.e(1),o.e(7),o.e(10),o.e(11),o.e(12),o.e(17),o.e(25),o.e(70),o.e(95),o.e(8),o.e("login-dialog")]).then(o.bind(null,"hdTl")),null!==t&&(this.tradingPanel=new G(t),e=new Q(t,function(){return Object(u.ensureNotNull)(s.tradingPanel).close()}),this.tradingPanel.addPage(H.d.DomPanel,e),r=new K,this.tradingPanel.addPage(H.d.OrderPanel,r),i=C.getValue(h.settingsKeys.TRADING_PANEL_ACTIVE_PAGE),n=C.getBool(h.settingsKeys.TRADING_PANEL_OPENED,!1),window.is_authenticated?(i&&this.tradingPanel.activePage.setValue(i),n&&!!1&&this.tradingPanel.open(),this.tradingPanel.isPageOpened(H.d.OrderPanel)&&this.tradingPanel.isAvailable.value()&&this.setOrderPanelVisibility(!0)):this.tradingPanel.close(),Object(T.a)(function(){return{}},this.tradingPanel.activePage,this.tradingPanel.isOpened).subscribe(function(){s._domPanelVisibility.setValue(Object(u.ensureNotNull)(s.tradingPanel).isPageOpened(H.d.DomPanel)),s._orderPanelVisibility.setValue(Object(u.ensureNotNull)(s.tradingPanel).isPageOpened(H.d.OrderPanel))}),
this._loginDialogRenderer=Promise.all([o.e("react"),o.e(1),o.e(7),o.e(10),o.e(11),o.e(12),o.e(17),o.e(25),o.e(70),o.e(95),o.e(8),o.e("login-dialog")]).then(o.bind(null,"hdTl")))}return t.prototype.setChartWidgetCollection=function(t){var e,o=this;Object(u.assert)(null===this._chartWidgetCollection,"ChartWidgetCollection can be set only once"),this._chartWidgetCollection=t,this._guiAccessor=new N(t),new ct(this),this._loadState(),C.onSync.subscribe(this,this._loadState),e=function(){o._save()},this.hideFloatingPanel.subscribe(e),this.noConfirmEnabled.subscribe(e),this.showOnlyRejectionNotifications.subscribe(e),this.showPricesWithZeroVolume.subscribe(e),this.orderExecutedSoundParams.enabled.subscribe(e),window.addEventListener("offline",this._offlineListener),window.addEventListener("online",this._onlineListener),this.bindShortcuts(),this._registerCustomSources(t)},t.prototype.domPanelVisibility=function(){return this._domPanelVisibility},t.prototype.orderPanelVisibility=function(){return this._orderPanelVisibility},t.prototype.realtimeProvider=function(){return this._realtimeProvider},t.prototype.toggleTradingWidget=function(){return TradingView.bottomWidgetBar?TradingView.bottomWidgetBar.activateTradingTab():Promise.resolve()},t.prototype.tradingWizard=function(){return this._tradingWizard},t.prototype.showTradingProperties=function(){this._gui()&&this._gui().showTradingProperties()},t.prototype.brokersList=function(){return l.brokersList()},t.prototype.brokersPlans=function(){return this._getBrokerPlans()},t.prototype.activeBroker=function(){return this._activeBroker},t.prototype.brokerCommandsUI=function(){return this._brokerCommandsUI},t.prototype.trackEvent=function(t,e,o){var r,i,n=t?"["+t+"] "+e:e;this._gui()&&(r=this._activeBroker?this._activeBroker.metainfo().id+" Trading":"Trading No Broker",i=this._activeBroker?this._activeBroker.currentAccountType():void 0,this._gui().trackEvent(r,n,o||i))},t.prototype.showBrokerLoginDialog=function(){var t=this;this._loginDialogRenderer.then(function(e){e.showLoginDialog(Object(u.ensureNotNull)(t.activeBroker()),!1,function(){return t.selectBroker(null)},t.trackEvent.bind(t))})},t.prototype.selectBroker=function(t,e){void 0===e&&(e=!1),this._selectBrokerInternal(t,!0,e)},t.prototype.pickDefaultBroker=function(){var t,e,o;this._activeBroker||(t=null,1===(e=this.brokersList().filter(function(t){return!t.configFlags.isSuspended})).length?t=e[0].id:(o=C.getValue(h.settingsKeys.ACTIVE_BROKER))&&e.some(function(t){return t.id===o})&&(t=o),t&&this.selectBroker(t))},t.prototype.defaultContextMenuActions=function(t,e){var o=void 0===e?{}:e,r=o.onlyMainActions,i=void 0!==r&&r,n=o.gaOrigin,s=void 0===n?"Chart Context Menu":n;return Object(c.__awaiter)(this,void 0,void 0,function(){var e,o,r,n=this;return Object(c.__generator)(this,function(a){switch(a.label){case 0:return[4,this.suggestedQty().value(t.symbol)];case 1:return e=a.sent(),o=t.value||void 0,[4,this._makeSubActions(t,e)];case 2:return r=a.sent(),i||(r.push({name:"trade-new-order",action:function(){
n.trackEvent(s,"New Order"),n._checkAndPlaceOrder({limitPrice:o,qty:e,stopPrice:o,symbol:t.symbol},!1)},text:window.t("Create New Order..."),statName:"NewOrder"}),U.enabled("property_pages")&&(r.push({separator:!0}),r.push({name:"trade-properties",action:function(){n.trackEvent(s,"Trading Properties"),n.showTradingProperties()},text:window.t("Trading Settings..."),icon:lt,statName:"Properties"}))),[2,r]}})})},t.prototype.defaultDropdownMenuActions=function(t){function e(t){return t.length&&t.push(i),t}var o,r,i,n=this,s="Bottom Panel Dropdown",a=[];return null===this.tradingPanel?[]:(o=this.activeBroker(),r=t||{disconnect:!0,selectAnotherBroker:!U.enabled("trading_terminal"),showFloatingToolbar:!0,showOrderPanel:U.enabled("order_panel"),showDOM:U.enabled("dome_widget")&&o&&o.metainfo().configFlags.supportDOM,tradingProperties:!0,showHowToUse:o&&o.metainfo().configFlags.supportHowToUse},U.enabled("property_pages")||(r.tradingProperties=!1),i={separator:!0},r.showFloatingToolbar&&a.push({action:function(){var t=n.hideFloatingPanel.value();n.trackEvent(s,"Show Floating Panel",t?"Check":"Uncheck"),n.hideFloatingPanel.setValue(!t)},checkable:!0,checked:!this.hideFloatingPanel.value(),text:window.t("Show Buy/Sell Panel")}),r.showOrderPanel&&U.enabled("order_panel")&&a.push({action:function(){var t=Object(u.ensureNotNull)(n.tradingPanel).isPageOpened(H.d.OrderPanel);n.trackEvent(s,"Show Order Panel",t?"Uncheck":"Check"),n.setOrderPanelVisibility(!t)},checkable:!0,checked:this.tradingPanel.isPageOpened(H.d.OrderPanel),text:$.t("Show Order Panel")}),r.showDOM&&U.enabled("dome_widget")&&a.push({action:function(){var t=Object(u.ensureNotNull)(n.tradingPanel).isPageOpened(H.d.DomPanel);n.trackEvent(s,"Show DOM",t?"Uncheck":"Check"),n.setDomPanelVisibility(!t)},checkable:!0,checked:this.tradingPanel.isPageOpened(H.d.DomPanel),text:window.t("Show DOM")}),r.tradingProperties&&(e(a),a.push({action:function(){n.showTradingProperties(),n.trackEvent(s,"Trading Properties")},text:window.t("Trading Settings..."),icon:lt})),r.selectAnotherBroker&&(e(a),a.push({action:function(){return Object(c.__awaiter)(n,void 0,void 0,function(){var t,e;return Object(c.__generator)(this,function(o){switch(o.label){case 0:return t=this.activeBroker(),(e=t)?[4,Object(S.showDisconnectWarningIfNeeded)(t)]:[3,2];case 1:e=!o.sent(),o.label=2;case 2:return e?[2]:(this.selectBroker(null,!0),this.trackEvent(s,"Select Broker"),[2])}})})},text:window.t("Select Another Broker")})),r.disconnect&&(e(a),a.push({action:function(){return Object(c.__awaiter)(n,void 0,void 0,function(){var t,e;return Object(c.__generator)(this,function(o){switch(o.label){case 0:return this.trackEvent(s,"Disconnect"),t=this.activeBroker(),(e=t)?[4,Object(S.showDisconnectWarningIfNeeded)(t)]:[3,2];case 1:e=o.sent(),o.label=2;case 2:return e&&t.disconnect(),[2]}})})},text:window.t("Log Out")})),a)},t.prototype.chartContextMenuActions=function(t,e){
return(this._activeBroker&&1===this._activeBroker.connectionStatus()?this._activeBroker.chartContextMenuActions(t,e):this.defaultContextMenuActions(t,e)).then(function(t){return Object(S.convertActionDescriptionsToActions)(t)})},t.prototype.connectStatus=function(){return this._activeBroker?this._activeBroker.connectionStatus():3},t.prototype.bindShortcuts=function(){var t,e=this;this._hotkeys||(this._hotkeys=J.createGroup({desc:"Trading"}),t=function(t){var o=e._gui().proSymbol();e.suggestedQty().value(o).then(function(r){e.realtimeProvider().quotesSnapshot(o).then(function(i){var n=i.bid,s=i.ask,a={price:void 0!==n&&void 0!==s?(n+s)/2:NaN,qty:r,side:t,symbol:o,type:2};e.trackEvent("Shortcut",-1===t?"Sell":"Buy"),e._checkAndPlaceOrder(a)})})},this._hotkeys.add({desc:"Buy",hotkey:J.Modifiers.Shift+66,handler:function(){return t(1)}}),this._hotkeys.add({desc:"Sell",hotkey:J.Modifiers.Shift+83,handler:function(){return t(-1)}}))},t.prototype.suggestedQty=function(){var t,e=this;return this._suggestedQty||(t=new b.a,this._suggestedQty={changed:t,setValue:function(o,r){e._setSymbolQty(o,r),t.fire(o)},value:function(t){return e.realtimeProvider().symbolInfo(t).then(function(o){var r=e._getSymbolQty(t)||e._getOldSymbolQty(t),i=void 0!==o.qty.default?o.qty.default:o.qty.min;return r?Object(d.alignTo)(Math.max(Math.min(o.qty.max,+r),o.qty.min),o.qty.step):i})}}),this._suggestedQty},t.prototype.formatter=function(t){return this.realtimeProvider().formatter(t)},t.prototype.showSuccessNotification=function(t,e,o){void 0===o&&(o=1e4),this.showOnlyRejectionNotifications.value()||this._showNotification(t,e,"success",o),U.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"success",o),this._log(t,e)},t.prototype.showErrorNotification=function(t,e,o){void 0===o&&(o=25e3),this._showNotification(t,e,"danger",o),U.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"danger",o),this._log(t,e)},t.prototype.getNotifications=function(){var t=this;return this._notifications.filter(function(e){return e.account===t._account&&e.broker===(t._activeBroker?t._activeBroker.metainfo().id:null)})},t.prototype.setDomPanelVisibility=function(t){null!==this.tradingPanel&&(t?this.tradingPanel.openPage(H.d.DomPanel):this.tradingPanel.close())},t.prototype.setOrderPanelVisibility=function(t){this._getOrderViewController().then(function(e){t?e.openPanel():e.closePanel()})},t.prototype.orderViewController=function(){return Object(u.ensureNotNull)(this._orderViewController)},t.prototype.tradingStat=function(){return this._tradingStat},t.prototype.verifyBrokerLiveAccount=function(){return Object(c.__awaiter)(this,void 0,void 0,function(){return Object(c.__generator)(this,function(t){return this._verifyLiveAccount(),[2,null!==this._accountVerificationPromise?this._accountVerificationPromise:Promise.reject("Account verification is not needed")]})})},t.prototype._getOrderViewController=function(){var t=this;return null===this._orderViewController?this._createOrderController().then(function(){
return t._getOrderViewController()}):Promise.resolve(this._orderViewController)},t.prototype._getSymbolQty=function(t){var e=this._getBrokerSymbolsQty();if(e)return e[t]},t.prototype._getOldSymbolQty=function(t){var e=C.getFloat(h.settingsKeys.QTY+t);return void 0!==e&&(this._setSymbolQty(t,e),C.remove(h.settingsKeys.QTY+t)),e},t.prototype._getBrokerSymbolsQty=function(){var t;if(this._activeBroker)return t=this._activeBroker.metainfo().id,C.getJSON(h.settingsKeys.BROKERS_QTY,{})[t]},t.prototype._setSymbolQty=function(t,e){var o,r;this._activeBroker&&(o=this._activeBroker.metainfo().id,(r=C.getJSON(h.settingsKeys.BROKERS_QTY,{}))[o]||(r[o]={}),r[o][t]=e,C.setJSON(h.settingsKeys.BROKERS_QTY,r))},t.prototype._selectBrokerInternal=function(t,e,o){return void 0===o&&(o=!1),Object(c.__awaiter)(this,void 0,void 0,function(){var r,i,n,s,a,u=this;return Object(c.__generator)(this,function(c){switch(c.label){case 0:return!0===this._switchingBroker?(ht.logWarn("Broker is already selected, but a new broker id: "+t+" was received."),[2]):(r=this._activeBroker?this._activeBroker.metainfo().id:null,t===r?[2]:(this._activeBroker&&(this._activeBroker.connectionStatusUpdate.unsubscribe(this,this._connectionListener),this._activeBroker.disconnect(o||!e),this._activeBroker.destroy(),this._activeBroker=null,this._updateConnectionStatus(3,e)),null==t?[3,3]:(this._switchingBroker=!0,i=void 0,n=function(t){u._activeBroker&&(ht.logWarn("Another one connecting broker detected. Disconnect it."),u._activeBroker.disconnect(o),u._activeBroker.destroy()),u._switchingBroker=!1,u._activeBroker=t,t.connectionStatusUpdate.subscribe(u,u._connectionListener),t.tryRestoreSession(),C.setValue(h.settingsKeys.ACTIVE_BROKER,t.metainfo().id),u.onBrokerChange.fire(u._activeBroker),u._brokerCommandsUI=new W(u._activeBroker,u._guiAccessor,u.noConfirmEnabled,u._getOrderViewController.bind(u),u.showErrorNotification.bind(u)),null!==u.tradingPanel&&u._getOrderViewController(),u._updateConnectionStatus(u.connectStatus())},[3,2])));case 1:s=c.sent(),i=s.filter(function(e){return e.slug_name===t})[0],c.label=2;case 2:return(a=l.createBrokerConnection(this,t,i)).then(n),a.catch(function(t){return ht.logError(t)}),[3,4];case 3:e&&setTimeout(function(){return C.remove(h.settingsKeys.ACTIVE_BROKER)}),this.onBrokerChange.fire(null),this._brokerCommandsUI=null,this._accountVerificationPromise=null,c.label=4;case 4:return[2]}})})},t.prototype._gui=function(){return this._guiAccessor},t.prototype._addNotificationRow=function(t,e,o,r){var i={id:this._notifications.length,account:this._account,broker:this._activeBroker?this._activeBroker.metainfo().id:null,time:new Date,title:t,text:e,type:o};this._notifications.push(i),this.onNewNotification.fire(i)},t.prototype._offlineHandler=function(){this._selectBrokerInternal(null,!1),ht.logNormal("The connection to the Internet was interrupted")},t.prototype._onlineHandler=function(){var t=C.getValue(h.settingsKeys.ACTIVE_BROKER);t&&(this._selectBrokerInternal(t,!1),ht.logNormal("The connection to the Internet was restored"))},
t.prototype._showNotification=function(t,e,o,r){this._gui()&&this._gui().showNotification(t,e,o,r)},t.prototype._showReviewDialogIfNeeded=function(t,e){var o;null!==this._activeBroker&&(o=this._activeBroker,h.settingsKeys.REVIEW_DIALOG_WAS_SHOWED,o.metainfo().id)},t.prototype._connectionListener=function(t,e){var o=this.connectStatus();null!==this.tradingPanel&&this.tradingPanel.isLoading.setValue(2===o),this._showReviewDialogIfNeeded(t,e),3===t&&e&&e.disconnectType===p.DisconnectType.LogOut&&this._selectBrokerInternal(null,!1),this._updateConnectionStatus(o,!0,e)},t.prototype._updateConnectionStatus=function(t,e,o){var r;void 0===e&&(e=!0),this.onConnectionStatusChange.fire(t,o),this._log("Connection status",ft[t]),e&&(r=this._activeBroker?this._activeBroker.metainfo().id:void 0,C.setValue(h.settingsKeys.ACTIVE_BROKER,r,{forceFlush:!0})),this._activeBroker&&(1===t?(this._info=this._activeBroker.accountManagerInfo(),this._info.account&&(this._account=this._info.account.value().id||this._info.account.value().name,this._info.account.subscribe(this._updateAccountId))):(this._accountVerificationPromise=null,this._info&&this._info.account&&this._info.account.unsubscribe(this._updateAccountId)))},t.prototype._verifyLiveAccount=function(){if(null===this._accountVerificationPromise){var t=Object(u.ensureNotNull)(this._activeBroker);t.metainfo().configFlags.supportVerifyLiveAccount&&(t.currentAccountType(),p.AccountType.Live)}},t.prototype._save=function(){C.setJSON(h.settingsKeys.PROPERTIES,{hideFloatingPanel:+!!this.hideFloatingPanel.value(),noConfirmEnabled:+!!this.noConfirmEnabled.value(),qweqrq:+!!this.showOnlyRejectionNotifications.value(),showPricesWithZeroVolume:+!!this.showPricesWithZeroVolume.value(),orderExecutedSoundParams:JSON.stringify({enabled:+!!this.orderExecutedSoundParams.enabled.value(),name:this.orderExecutedSoundParams.name})})},t.prototype._loadState=function(){var t,e=C.getJSON(h.settingsKeys.PROPERTIES,{});this.hideFloatingPanel.setValue(!!e.hideFloatingPanel),this.noConfirmEnabled.setValue(!!e.noConfirmEnabled),this.showOnlyRejectionNotifications.setValue(!!e.qweqrq),e.hasOwnProperty("showPricesWithZeroVolume")?this.showPricesWithZeroVolume.setValue(!!e.showPricesWithZeroVolume):this.showPricesWithZeroVolume.setValue(!0),e.hasOwnProperty("orderExecutedSoundParams")&&(t=JSON.parse(e.orderExecutedSoundParams),this.orderExecutedSoundParams.enabled.setValue(!!t.enabled),this.orderExecutedSoundParams.name=t.name)},t.prototype._log=function(t,e){ht.logNormal((this._activeBroker?this._activeBroker.metainfo().id+" Trading: ":"")+t+" - "+e)},t.prototype._checkAndPlaceOrder=function(t,e){var o,r,i=this;if(void 0===e&&(e=!0),o=this.activeBroker(),r=this.brokerCommandsUI(),o&&r){if(1!==o.connectionStatus())return void this.toggleTradingWidget();r.placeOrder(t,e)}else this.toggleTradingWidget().then(function(){return i.onNeedSelectBroker.fire()})},t.prototype._makeSubAction=function(t,e,o,r,i,n){var s=this,a="Chart Context Menu",c=1===e?"Buy":"Sell",u=1===o?"Limit":"Stop",d=c+u,l={
BuyLimit:window.t("Buy {symbol} Limit {qty} @ {value}").format({symbol:t.displaySymbol,qty:Object(B.abbreviatedNumber)(n),value:i}),SellStop:window.t("Sell {symbol} Stop {qty} @ {value}").format({symbol:t.displaySymbol,qty:Object(B.abbreviatedNumber)(n),value:i}),SellLimit:window.t("Sell {symbol} Limit {qty} @ {value}").format({symbol:t.displaySymbol,qty:Object(B.abbreviatedNumber)(n),value:i}),BuyStop:window.t("Buy {symbol} Stop {qty} @ {value}").format({symbol:t.displaySymbol,qty:Object(B.abbreviatedNumber)(n),value:i})};return{name:("trade-"+c+"-"+u).toLowerCase(),action:function(){var i,d;s.trackEvent(a,c+" "+u),i=1===o?"limitPrice":"stopPrice",d={qty:n,side:e,symbol:t.symbol,type:o},null!==r&&(d[i]=r),s._checkAndPlaceOrder(d)},text:l[d],statName:d}},t.prototype._createOrderController=function(){var t=this;return null===this.tradingPanel?Promise.resolve():(null===this._orderControllerPromise&&(this._orderControllerPromise=new Promise(function(e){Promise.all([o.e("react"),o.e(104),o.e(20),o.e("order-view-controller")]).then(function(r){var i=o("3bpA").OrderViewController;e(new i({resizerBridge:Object(u.ensureNotNull)(t._resizerBridge),onNeedSelectBroker:t.onNeedSelectBroker,realtimeProvider:t.realtimeProvider(),suggestedQty:t.suggestedQty(),trackEvent:t.trackEvent.bind(t),toggleTradingWidget:t.toggleTradingWidget.bind(t),showErrorNotification:t.showErrorNotification.bind(t)},{container:Object(u.ensureNotNull)(t.tradingPanel).container,isAvailable:Object(u.ensureNotNull)(t.tradingPanel).isAvailable,isOpened:Object(u.ensureNotNull)(t.tradingPanel).isOpened,activePage:Object(u.ensureNotNull)(t.tradingPanel).activePage,close:Object(u.ensureNotNull)(t.tradingPanel).close.bind(t.tradingPanel),openPage:Object(u.ensureNotNull)(t.tradingPanel).openPage.bind(t.tradingPanel)}))}.bind(null,o)).catch(void 0)}).then(function(e){t._orderControllerPromise=null,t._orderViewController=e})),this._orderControllerPromise)},t.prototype._registerCustomSources=function(t){var e=this;t.addCustomSource("trading",function(t){return new dt.a(t,e)})},t.prototype._makeSubActions=function(t,e){return Object(c.__awaiter)(this,void 0,void 0,function(){var o,r,i,n,s,a,u,l,p,h,f,_,b,m,y,g,v,k;return Object(c.__generator)(this,function(c){switch(c.label){case 0:return o=[],r=this.activeBroker(),i=null===r,n=null===r,null===r||1!==r.connectionStatus()?[3,2]:[4,r.isTradable(t.symbol)];case 1:b=c.sent(),c.label=2;case 2:return null!==r&&b&&b.tradable&&null!==t.value?(m=r.metainfo().configFlags,[4,r.symbolInfo(t.symbol)]):[3,5];case 3:return y=c.sent(),P=t.value,w=y.minTick,g=Object(d.fixComputationError)(Math.round(P/w)*w),s=g,u=g,l=g,a=g,i=void 0!==m.supportLimitOrders,n=void 0!==m.supportStopOrders,void 0!==y.limitPriceStep&&(v=Object(S.roundToStepByPriceTypeAndSide)(t.value,y.limitPriceStep,1,1),s=v,u=Object(S.roundToStepByPriceTypeAndSide)(t.value,y.limitPriceStep,1,-1)),void 0!==y.stopPriceStep&&(v=Object(S.roundToStepByPriceTypeAndSide)(t.value,y.stopPriceStep,2,1),l=v,a=Object(S.roundToStepByPriceTypeAndSide)(t.value,y.stopPriceStep,2,-1)),
[4,r.formatter(t.symbol,!1)];case 4:return k=c.sent(),p=k.format(s),h=k.format(a),f=k.format(u),_=k.format(l),[3,6];case 5:s=u=l=a=t.value,p=h=f=_=t.formattedValue,c.label=6;case 6:return null!==t.value&&t.value<=t.last?(i&&o.push(this._makeSubAction(t,1,1,s,p,e)),n&&o.push(this._makeSubAction(t,-1,3,a,h,e))):null!==t.value&&t.value>=t.last&&(i&&o.push(this._makeSubAction(t,-1,1,u,f,e)),n&&o.push(this._makeSubAction(t,1,3,l,_,e))),[2,o]}var P,w})})},t.prototype._initPaidBrokersByUserRegion=function(){this._brokersListPromise=fetch("/api/v1/brokers/trading_panel",{method:"GET"}).then(function(t){return t.json()})},t.prototype._getBrokerPlans=function(){return Object(c.__awaiter)(this,void 0,void 0,function(){var t,e;return Object(c.__generator)(this,function(o){switch(o.label){case 0:t=[],o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this._brokersListPromise];case 2:if(t=o.sent(),!Array.isArray(t))throw new Error("Request result is not valid");return[3,4];case 3:return e=o.sent(),ht.logError("Failed to fetch broker list by user region: "+e.message),[3,4];case 4:return[2,t]}})})},t}()},Hgre:function(t,e,o){"use strict";function r(t){var e,o,r,i=[];for(e=0,o=t;e<o.length;e++)(r=o[e]).canBeClosed||(r.canBeClosed=!0,i.push(r));return i}function i(t){var e,o,r,i,n,s,a,c,u,d,l,p,f={};for(e=0,o=t;e<o.length;e++)void 0===(i=f[(r=o[e]).symbol])&&(i={oldest:null,all:[]},f[r.symbol]=i),(null===i.oldest||i.oldest.date>r.date)&&(i.oldest=r),i.all.push(r);for(n=[],s=0,a=Object.keys(f);s<a.length;s++)for(c=a[s],u=0,d=(i=Object(h.ensureDefined)(f[c])).all;u<d.length;u++)r=d[u],p=(l=i.oldest===r)!==r.canBeClosed,r.canBeClosed=l,p&&n.push(r);return n}function n(t){var e,o,r,i,n,s,a,c,u,d,l,p,f,_,b,m,y,g,v={};for(e=0,o=t;e<o.length;e++)void 0===(i=v[(r=o[e]).symbol])&&(i={},v[r.symbol]=i),void 0===(n=i[r.qty])&&(n={oldest:null,all:[]},i[r.qty]=n),(null===n.oldest||n.oldest.date>r.date)&&(n.oldest=r),n.all.push(r);for(s=[],a=0,c=Object.keys(v);a<c.length;a++)for(u=c[a],d=Object(h.ensureDefined)(v[u]),l=0,p=Object.keys(d);l<p.length;l++)for(f=p[l],b=0,m=(_=Object(h.ensureDefined)(d[f])).all;b<m.length;b++)r=m[b],g=(y=_.oldest===r)!==r.canBeClosed,r.canBeClosed=y,g&&s.push(r);return s}function s(t){Object(h.assert)("object"!=typeof t,"Expected not an object")}function a(){return!0}function c(t,e){t.configFlags=Object(Y.a)(t.configFlags),G.push({metainfo:t,createBrokerFunction:e})}function u(){return G.map(function(t){return t.metainfo})}function d(t,e,o){return new Promise(function(r){var i=G.filter(function(t){return t.metainfo.id===e})[0],n=new H(t,i.metainfo);i.createBrokerFunction(n,function(e){var s=new z.a(i.metainfo.id);r(new C(i.metainfo,e,n,s,t.tradingStat(),o))})})}var l,p,h,f,_,b,m,y,g,v,k,P,w,O,C,S,B,T,E,j,I,D,A,M,N,U,L,R,x,F,V,q,W,Q,K,H,z,Y,G;o.r(e),l=o("mrSG"),o("P5fv"),o("YFKU"),p=o("Kxc7"),h=o("Eyy1"),f=function(){function t(t,e,o){var r=this;this._symbol=null,this._side=null,this._realtimeData=null,this._avgPrice=null,this._positionId=t,this._adapter=e,this._host=o,this._adapter.positionById(t).then(function(t){
var e=Object(h.ensureDefined)(t);r._symbol=e.symbol,r._side=e.side,r._onPositionChanged(e),r._onRealtimeBinded=r._onRealtime.bind(r),r._adapter.subscribeRealtime(r._symbol,r._onRealtimeBinded),r._adapter.positionUpdate.subscribe(r,r._onPositionChanged)})}return t.prototype.stop=function(){this._symbol&&this._adapter.unsubscribeRealtime(this._symbol,this._onRealtimeBinded),this._adapter.positionUpdate.unsubscribe(this,this._onPositionChanged)},t.prototype._updatePL=function(){if(this._realtimeData&&this._realtimeData.trade&&this._avgPrice){var t=(this._realtimeData.trade-Math.abs(this._avgPrice))*(1===this._side?1:-1);this._host.plUpdate(this._positionId,t)}},t.prototype._onRealtime=function(t,e){this._realtimeData=e,this._updatePL()},t.prototype._onPositionChanged=function(t){this._avgPrice=t.avgPrice,this._updatePL()},t}(),_=o("ogJP"),b=o("aIyQ"),m=o.n(b),y=o("4qhP"),g=function(){function t(t){this._objects={},this._started=!1,this._isObjectsRequestActual=!1,this._ordersPromise=null,this._getter=t,this.updateDelegate=new m.a,this.partialUpdateDelegate=new m.a}return t.prototype.start=function(){this._started||(this._started=!0,this._ordersPromise=this._requestObjects())},t.prototype.stop=function(){this._objects={},this._started=!1,this._ordersPromise=null,this._isObjectsRequestActual=!1},t.prototype.update=function(t,e){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(this._objects[t.id]=t,this._onObjectUpdated(t,e)))},t.prototype.partialUpdate=function(t,e){var o,r,i;this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(Object(_.isObject)(t)?(o=t.id,r=t):(o=t,r=Object(h.ensure)(e)),(i=this._objects[o])&&(Object.assign(i,r),this.partialUpdateDelegate.fire(i,r))))},t.prototype.fullUpdate=function(){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:this._ordersPromise=this._requestObjects())},t.prototype.getObjects=function(){return this._ordersPromise||Promise.resolve(Object.values(this._objects))},t.prototype._onObjectUpdated=function(t,e){this.updateDelegate.fire(t,e)},t.prototype._onAllObjectsUpdated=function(){var t=this;this._objectsCache().forEach(function(e){return t.updateDelegate.fire(e,!0)})},t.prototype._objectsCache=function(){return Object.values(this._objects)},t.prototype._requestObjects=function(){return Object(l.__awaiter)(this,void 0,void 0,function(){var t;return Object(l.__generator)(this,function(e){switch(e.label){case 0:t=[],e.label=1;case 1:return this._isObjectsRequestActual=!0,[4,this._getter()];case 2:t=e.sent(),e.label=3;case 3:if(!this._isObjectsRequestActual)return[3,1];e.label=4;case 4:return this._objects=Object(y.objectsArrayToMap)(t,"id"),this._ordersPromise=null,this._isObjectsRequestActual=!1,this._onAllObjectsUpdated(),[2,t]}})})},t}(),v=o("uOxu"),k=o("d13A"),P=function(t){function e(e,o){var r=t.call(this,e)||this;return r._brokerConfigGetter=o,r}return Object(l.__extends)(e,t),e.prototype._onObjectUpdated=function(e,o){this._patchTrades(this._objectsCache().filter(function(t){
return t.symbol===e.symbol&&0!==t.qty}),e,o),t.prototype._onObjectUpdated.call(this,e,o)},e.prototype._onAllObjectsUpdated=function(){this._patchTrades(this._objectsCache().filter(function(t){return 0!==t.qty})),t.prototype._onAllObjectsUpdated.call(this)},e.prototype._patchTrades=function(e,o,s){var a,c,u,d=this._brokerConfigGetter();for(a=0,c=(d.requiresFIFOCloseTrades?d.fifoOnlyForSameQty?n:i:r)(e);a<c.length;a++)o!==(u=c[a])&&t.prototype._onObjectUpdated.call(this,u,s)},e}(g),w=o("Lj6W"),O=Object(v.getLogger)("Trading.BrokerConnectionAdapter"),C=function(){function t(t,e,o,r,i,n){var s,a,c=this;this.connectionStatusUpdate=new m.a,this.executionUpdate=new m.a,this.tradingOperationFinished=new m.a,this.fullUpdate=new m.a,this.orderDialogOptionsUpdate=new m.a,this.positionDialogOptionsUpdate=new m.a,this._brokerPlan=null,this._subscriptions={},this._lastFireResult={},this._fakeDomeSubscriptions={},this._formattersCache={},this._spreadFormattersCache={},this._quantityFormattersCache={},this._tradesCache=null,this._profitLossEmitters={},this._fakePositionUpdateDelegate=null,this._realtimeSubscriptionState=[],this.config=t.configFlags,this._brokerMetainfo=this._patchMetainfo(t),this._brokerPlan=n||null,this._brokerConnection=e,this._host=o,this._tradingStat=i,o.setBrokerConnectionAdapter(this),this._initializeConnectProtection(),this._positionsCache=e.positions?new g(function(){return e.positions?e.positions():Promise.resolve([])}):null,this._tradesCache=e.trades?new P(function(){return e.trades?e.trades():Promise.resolve([])},function(){return c.config}):null,this._ordersCache=new g(function(){return e.orders()}),s=function(t){1===t?(null!==c._positionsCache&&c._positionsCache.start(),c._ordersCache.start(),c._tradesCache&&c._tradesCache.start()):(null!==c._positionsCache&&c._positionsCache.stop(),c._ordersCache.stop(),c._tradesCache&&c._tradesCache.stop())},this.connectionStatusUpdate.subscribe(null,s),s(this.connectionStatus()),t.configFlags.supportPLUpdate||(this._brokerConnection.subscribePL=function(t){c._profitLossEmitters[t]=c._createProfitLossEmitter(t)},this._brokerConnection.unsubscribePL=function(t){var e=c._profitLossEmitters[t];e&&(e.stop(),c._profitLossEmitters[t]=null)}),this._originalDOMESubscriptionMethods={subscribeDOME:e.subscribeDOME,unsubscribeDOME:e.unsubscribeDOME},a=function(t){var e,o,r;1===t&&(e=!c._brokerMetainfo.configFlags.supportLevel2Data,o=function(t){c._fakeSubscribeDOME(t)},r=function(t){c._fakeUnsubscribeDOME(t)},c._brokerConnection.subscribeDOME=e?o:c._originalDOMESubscriptionMethods.subscribeDOME,c._brokerConnection.unsubscribeDOME=e?r:c._originalDOMESubscriptionMethods.unsubscribeDOME)},this.connectionStatusUpdate.subscribe(null,a),t.configFlags.supportPositions||(this._fakePositionUpdateDelegate=new m.a),this._brokerRealtimeAdapter=r}return t.prototype.tryRestoreSession=function(){if(this._brokerConnection.tryRestoreSession)return this._brokerConnection.tryRestoreSession()},Object.defineProperty(t.prototype,"orderUpdate",{get:function(){return this._ordersCache.updateDelegate},
enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"positionUpdate",{get:function(){return null===this._fakePositionUpdateDelegate?Object(h.ensure)(this._positionsCache).updateDelegate:this._fakePositionUpdateDelegate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tradeUpdate",{get:function(){return Object(h.ensure)(this._tradesCache).updateDelegate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"orderPartialUpdate",{get:function(){return this._ordersCache.partialUpdateDelegate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"positionPartialUpdate",{get:function(){return null===this._fakePositionUpdateDelegate?Object(h.ensure)(this._positionsCache).partialUpdateDelegate:this._fakePositionUpdateDelegate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tradePartialUpdate",{get:function(){return Object(h.ensure)(this._tradesCache).partialUpdateDelegate},enumerable:!0,configurable:!0}),t.prototype.onOrderUpdate=function(t,e){this._ordersCache.update(t,e)},t.prototype.onOrderPartialUpdate=function(t,e){this._ordersCache.partialUpdate(t,e)},t.prototype.onPositionUpdate=function(t,e){if(Object(h.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),0===t.qty){var o=this._lastFireResult[t.symbol];o&&delete o.PL}Object(h.ensure)(this._positionsCache).update(t,e)},t.prototype.onPositionPartialUpdate=function(t,e){Object(h.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),Object(h.ensure)(this._positionsCache).partialUpdate(t,e)},t.prototype.onTradeUpdate=function(t,e){if(Object(h.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),0===t.qty){var o=this._lastFireResult[t.symbol];o&&delete o.TradePL}Object(h.ensure)(this._tradesCache).update(t,e)},t.prototype.onTradePartialUpdate=function(t,e){Object(h.ensure)(this._tradesCache).partialUpdate(t,e)},t.prototype.onFullUpdate=function(){null!==this._positionsCache&&this._positionsCache.fullUpdate(),this._ordersCache.fullUpdate(),this._tradesCache&&this._tradesCache.fullUpdate(),this.fullUpdate.fire()},t.prototype.patchConfig=function(t){Object(w.migrateConfigFlags)(t),Object.assign(this.config,t),Object.assign(this._brokerMetainfo.configFlags,t),this._brokerMetainfo=this._patchMetainfo(this._brokerMetainfo)},t.prototype.patchOrderDialogOptions=function(t){void 0===this._brokerMetainfo.orderDialogOptions&&(this._brokerMetainfo.orderDialogOptions={}),Object.assign(this._brokerMetainfo.orderDialogOptions,t),this.orderDialogOptionsUpdate.fire(t)},t.prototype.patchPositionDialogOptions=function(t){void 0===this._brokerMetainfo.positionDialogOptions&&(this._brokerMetainfo.positionDialogOptions={}),Object.assign(this._brokerMetainfo.positionDialogOptions,t),this.positionDialogOptionsUpdate.fire(t)},t.prototype.chartContextMenuActions=function(t,e){return this._brokerConnection.chartContextMenuActions(t,e)},t.prototype.buttonDropdownActions=function(){return this._host.buttonDropdownActions()},t.prototype.connectionStatus=function(){
return this._brokerConnection.connectionStatus()},t.prototype.isConnected=function(){return 1===this._brokerConnection.connectionStatus()},t.prototype.signIn=function(t,e,o){return Object(v.getLogger)("Trading."+this._brokerMetainfo.id+".Connection").logNormal("Try to login with username: "+t),this._brokerConnection.signIn(t,e,o)},t.prototype.disconnect=function(t){return void 0===t&&(t=!1),this._brokerConnection.disconnect(t)},t.prototype.currentAccount=function(){return this._brokerConnection.currentAccount?this._brokerConnection.currentAccount():""},t.prototype.currentAccountType=function(){return this._brokerConnection.currentAccountType?this._brokerConnection.currentAccountType():void 0},t.prototype.metainfo=function(){return this._brokerMetainfo},t.prototype.brokerPlan=function(){return this._brokerPlan},t.prototype.bro=function(){return this._brokerConnection},t.prototype.fireSubscription=function(t,e,o,r){if(void 0===this._lastFireResult[e]&&(this._lastFireResult[e]={Realtime:null,PL:null,Equity:null,DOME:null,TradePL:null,PipValue:null,MarginAvailable:null}),Object(h.ensure)(this._lastFireResult[e])[t]={data:o,time:Date.now()},void 0!==this._subscriptions[e]){var i=Object(h.ensure)(this._subscriptions[e]);Object(h.ensure)(i[t]).forEach(function(t){return t(e,o,r)})}},t.prototype.positions=function(t){return this.config.supportPositions?(this._makeSureBrokerIsConnected(),this._positions().then(function(e){return e.filter(function(e){return void 0===t||e.symbol===t})})):Promise.resolve([])},t.prototype.disconnectWarningMessage=function(){return this._brokerConnection.disconnectWarningMessage?this._brokerConnection.disconnectWarningMessage():null},t.prototype.trades=function(t){return this._makeSureBrokerIsConnected(),Object(h.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this._trades().then(function(e){return e.filter(function(e){return void 0===t||e.symbol===t})})},t.prototype.positionById=function(t){return this._brokerConnection.positionById?this._brokerConnection.positionById(t):this.positions().then(function(e){return e.find(function(e){return e.id===t})}).then(function(t){return t})},t.prototype.tradeById=function(t){return Object(h.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this.trades().then(function(e){return e.find(function(e){return e.id===t})}).then(function(t){return Object(h.ensure)(t)})},t.prototype.orders=function(t){var e=this;return this._makeSureBrokerIsConnected(),this._orders().then(function(o){return o.filter(function(e){return void 0===t||e.symbol===t}).map(function(t){return e._host.patchOrderUpdateTime(t)})})},t.prototype.executions=function(t){return this._makeSureBrokerIsConnected(),this._brokerConnection.executions(t)},t.prototype.orderById=function(t){var e=this;return this._makeSureBrokerIsConnected(),this._brokerConnection.orders().then(function(o){return e._host.patchOrderUpdateTime(o.filter(function(e){return e.id===t})[0])})},t.prototype.accountManagerInfo=function(){return this._brokerConnection.accountManagerInfo()},
t.prototype.isTradable=function(t){var e=this;return this._makeSureBrokerIsConnected(),this._brokerConnection.isTradable(t).then(function(o){return"object"!=typeof o&&(o={tradable:o}),o.tradable||void 0!==o.reason||(o.reason=window.t("Symbol {symbol} cannot be traded through {broker}.").format({symbol:t,broker:e._brokerMetainfo.title})),o})},t.prototype.formatter=function(t,e){return void 0===e&&(e=!0),this._makeSureBrokerIsConnected(),this._formattersCache[t]||(this._formattersCache[t]=this._brokerConnection.formatter&&this._brokerConnection.formatter(t,e)||this._host.defaultFormatter(t,e)),Object(k.makeTimeLimited)(this._formattersCache[t],1e4,"formatter not received")},t.prototype.spreadFormatter=function(t){return this._makeSureBrokerIsConnected(),this._spreadFormattersCache[t]||(this._spreadFormattersCache[t]=this._brokerConnection.spreadFormatter&&this._brokerConnection.spreadFormatter(t)||this._host.defaultFormatter(t,!1)),Object(k.makeTimeLimited)(this._spreadFormattersCache[t],1e4,"spreadFormatter not received")},t.prototype.quantityFormatter=function(t){return this._makeSureBrokerIsConnected(),this._quantityFormattersCache[t]||(this._quantityFormattersCache[t]=this._brokerConnection.quantityFormatter&&this._brokerConnection.quantityFormatter(t)||this._host.quantityFormatter()),Object(k.makeTimeLimited)(this._quantityFormattersCache[t],1e4,"quantityFormatter not received")},t.prototype.placeOrder=function(t,e){var o=this;return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.placeOrder(t),!0,window.t("Order rejected"),function(){o._tradingStat.trackOrderPlaced(t),o._host.trackEvent("","SilentMode",o._host.silentOrdersPlacement().value()?"On":"Off")})},t.prototype.previewOrder=function(t){if(!this.config.supportOrderPreview||!this._brokerConnection.previewOrder)throw new Error("Order preview is not supported");return this._brokerConnection.previewOrder(t)},t.prototype.modifyOrder=function(t){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.modifyOrder(t),!0,window.t("Failed to modify order"))},t.prototype.cancelOrder=function(t){return s(t),this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrder(t),!0,window.t("Failed to cancel order"))},t.prototype.cancelOrders=function(t,e,o){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrders(t,e,o),!0,window.t("Failed to cancel one or more orders"))},t.prototype.closePosition=function(t){var e=this;return s(t),this._makeSureBrokerIsConnected(),this.config.supportClosePosition&&this._brokerConnection.closePosition?this.processErrors(this._brokerConnection.closePosition.call(this._brokerConnection,t),!0,window.t("Failed to close position")):this.positionById(t).then(function(t){var o=Object(h.ensureDefined)(t),r={qty:Math.abs(o.qty),side:1===o.side?-1:1,symbol:o.symbol,brokerSymbol:o.brokerSymbol,type:2};return e.processErrors(e._brokerConnection.placeOrder(r),!0,window.t("Failed to close position"))})},t.prototype.closeTrade=function(t){
if(s(t),this._makeSureBrokerIsConnected(),Object(h.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this._brokerConnection.closeTrade)return this.processErrors(this._brokerConnection.closeTrade(t),!0,window.t("Failed to close position"));throw new Error("Method closeTrade is not implemented")},t.prototype.reversePosition=function(t){var e=this;if(s(t),this._makeSureBrokerIsConnected(),this.config.supportMultiposition&&!this.config.supportNativeReversePosition)throw new Error("Cannot reverse position on multiposition acount");return this.config.supportNativeReversePosition&&this._brokerConnection.reversePosition?this.processErrors(this._brokerConnection.reversePosition(t),!0,window.t("Failed to reverse position")):this.positionById(t).then(function(t){var o=Object(h.ensureDefined)(t),r=function(){var t={qty:2*Math.abs(o.qty),side:1===o.side?-1:1,symbol:o.symbol,brokerSymbol:o.brokerSymbol,type:2};return e.placeOrder(t)};return e.processErrors(r(),!0,window.t("Failed to reverse position"),function(){return e._tradingStat.trackOrderPlaced()})})},t.prototype.editPositionBrackets=function(t,e,o){if(this._makeSureBrokerIsConnected(),this._brokerConnection.editPositionBrackets)return this.processErrors(this._brokerConnection.editPositionBrackets(t,e,o),!0,$.t("Failed to modify Stop Loss / Take Profit"));throw new Error("Method editPositionBrackets is not implemented")},t.prototype.editTradeBrackets=function(t,e){if(this._makeSureBrokerIsConnected(),Object(h.assert)(!!this.config.supportTradeBrackets,"Broker doesn`t support brackets on trades"),this._brokerConnection.editTradeBrackets)return this.processErrors(this._brokerConnection.editTradeBrackets(t,e),!0,$.t("Failed to modify Stop Loss / Take Profit"));throw new Error("Method editTradeBrackets is not implemented")},t.prototype.subscribeRealtime=function(t,e){return Object(l.__awaiter)(this,void 0,void 0,function(){var o,r,i;return Object(l.__generator)(this,function(n){switch(n.label){case 0:return this._makeSureBrokerIsConnected(),o={symbol:t,listener:e,provider:0},this._realtimeSubscriptionState.push(o),[4,this.symbolInfo(t)];case 1:return r=n.sent(),-1===(i=this._realtimeSubscriptionState.findIndex(function(o){return o.symbol===t&&o.listener===e}))?[2]:void 0!==r.hasQuotes&&!1===r.hasQuotes?(this._realtimeSubscriptionState[i].provider=1,[2,Object(h.ensure)(this._brokerRealtimeAdapter).subscribeRealtime(t,e)]):(this._realtimeSubscriptionState[i].provider=2,[2,this._addSubscription("Realtime",t,e)])}})})},t.prototype.quotesSnapshot=function(t){var e=this;return Object(k.makeTimeLimited)(new Promise(function(o){var r=function(t,i){i&&(i.trade||i.ask||i.bid)&&(e.unsubscribeRealtime(t,r),o(i))};e.subscribeRealtime(t,r)}),1e4,"quotesSnapshot not received")},t.prototype.subscribeDOME=function(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("DOME",t,e)},t.prototype.subscribePipValue=function(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("PipValue",t,e)},t.prototype.subscribePL=function(t,e){
return this._makeSureBrokerIsConnected(),this._addSubscription("PL",t,e)},t.prototype.subscribeTradePL=function(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("TradePL",t,e)},t.prototype.subscribeEquity=function(t){return this._makeSureBrokerIsConnected(),this._addSubscription("Equity","Equity",t)},t.prototype.subscribeMarginAvailable=function(t){return this._makeSureBrokerIsConnected(),this._addSubscription("MarginAvailable","MarginAvailable",t)},t.prototype.unsubscribeRealtime=function(t,e){var o=this._realtimeSubscriptionState.findIndex(function(o){return o.symbol===t&&o.listener===e});-1!==o&&(1===this._realtimeSubscriptionState[o].provider?Object(h.ensure)(this._brokerRealtimeAdapter).unsubscribeRealtime(t,e):this._removeSubscription("Realtime",t,e),this._realtimeSubscriptionState.splice(o,1))},t.prototype.unsubscribeDOME=function(t,e){this._removeSubscription("DOME",t,e)},t.prototype.unsubscribePipValue=function(t,e){this._removeSubscription("PipValue",t,e)},t.prototype.unsubscribePL=function(t,e){this._removeSubscription("PL",t,e)},t.prototype.unsubscribeTradePL=function(t,e){this._removeSubscription("TradePL",t,e)},t.prototype.unsubscribeEquity=function(t){this._removeSubscription("Equity","Equity",t)},t.prototype.unsubscribeMarginAvailable=function(t){this._removeSubscription("MarginAvailable","MarginAvailable",t)},t.prototype.accountInfo=function(){return Object(k.makeTimeLimited)(this._brokerConnection.accountInfo(),1e4,"accountInfo not received")},t.prototype.symbolInfo=function(t){return Object(k.makeTimeLimited)(this._brokerConnection.symbolInfo(t),1e4,"symbolInfo not received")},t.prototype.bugReportInfo=function(){function t(t){return JSON.parse(JSON.stringify(t))}function e(t){var o,r;if("object"!=typeof t)return t;if(Object(_.isArray)(t))return t.map(e);for(r in o={},t)"object"!=typeof t[r]&&(o[r]=t[r]);return o}var o=this;return Promise.all([this.orders(),this.positions(),this.config.supportTrades?this.trades():Promise.resolve([])]).then(function(r){return{activeBroker:o.metainfo().title,orders:e(t(r[0])),positions:e(t(r[1])),trades:e(t(r[2])),silentOrdersPlacement:o._host.silentOrdersPlacement().value(),floatingPanel:o._host.floatingTradingPanelVisibility().value(),account:o.currentAccount(),accountType:o.currentAccountType(),lastUpdates:o._lastFireResult,time:Date.now(),brokerSpecific:o._brokerConnection.bugReportInfo?o._brokerConnection.bugReportInfo():null}})},t.prototype.processErrors=function(t,e,o,r){var i=this;if(!Object(_.isPromise)(t))throw new Error("Broker incorrectly implements API, should return Promise");return t.then(r).then(a).catch(function(t){var r="";return"string"==typeof t?r=t:"object"==typeof t&&"string"==typeof t.message&&(r=t.message),e&&p.enabled("trading_notifications")?(0!==r.length&&("."!==r.slice(-1)&&(r+="."),r+=" "),r+=window.t("To learn more, please contact your broker."),i._host.showNotification(o||"",r,0)):O.logWarn(t),Promise.resolve(!1)}).then(function(t){return i.tradingOperationFinished.fire(t),t})},t.prototype.setDurations=function(t){
this._brokerMetainfo.durations=t.slice()},t.prototype.setSymbolSearchId=function(t){this._brokerMetainfo.symbolSearchId=t},t.prototype.getRealtimeDataCheckParams=function(){return this._brokerConnection.getRealtimeDataCheckParams?this._brokerConnection.getRealtimeDataCheckParams():{}},t.prototype.getVerifyLiveAccountParams=function(){if(void 0===this._brokerConnection.getVerifyLiveAccountParams)throw new Error("Method getVerifyLiveAccountParams for broker "+this._brokerMetainfo.id+" is not implemented");return this._brokerConnection.getVerifyLiveAccountParams()},t.prototype.unhideSymbolSearchGroups=function(){return this._brokerConnection.unhideSymbolSearchGroups?this._brokerConnection.unhideSymbolSearchGroups():[]},t.prototype.destroy=function(){void 0!==this._brokerConnection.destroy&&this._brokerConnection.destroy()},t.prototype._initializeConnectProtection=function(){var t=this,e=null,o=function(){e&&(clearTimeout(e),e=null)},r=function(r){if(o(),2===r){var i="oauth"===t.config.authorizationType?18e4:6e4;e=setTimeout(function(){t._host.selectBroker(),t._host.showNotification(window.t("Authorization Error"),window.t("The connection attempt failed. Please try again later."))},i)}};this.connectionStatusUpdate.subscribe(null,r)},t.prototype._fakeSubscribeDOME=function(t){var e=this;this._fakeDomeSubscriptions[t]=function(t,o){var r=o.ask||o.trade,i=o.bid||o.trade,n={snapshot:!0,asks:r?[{price:r,volume:o.ask_size||1/0}]:[],bids:i?[{price:i,volume:o.bid_size||1/0}]:[]};e._host.domeUpdate(t,n)},this.subscribeRealtime(t,this._fakeDomeSubscriptions[t])},t.prototype._fakeUnsubscribeDOME=function(t){this.unsubscribeRealtime(t,this._fakeDomeSubscriptions[t])},t.prototype._createProfitLossEmitter=function(t){return new f(t,this,this._host)},t.prototype._patchMetainfo=function(t){var e=Object(_.clone)(t);return e.configFlags.supportNativeReversePosition=!this.config.supportMultiposition||this.config.supportNativeReversePosition,e.configFlags.supportClosePosition=!0,e.configFlags.supportPLUpdate=!0,e},t.prototype._addSubscription=function(t,e,o){var r,i,n,s;void 0===this._subscriptions[e]&&(this._subscriptions[e]={Realtime:[],PL:[],Equity:[],DOME:[],TradePL:[],PipValue:[],MarginAvailable:[]}),i=(r=Object(h.ensure)(this._subscriptions[e]))[t].length>0,r[t].push(o),void 0!==(n=this._lastFireResult[e])&&void 0!==n[t]&&null!==n[t]&&o(e,n[t].data),!i&&r[t].length>0&&(s="subscribe"+t,this._brokerConnection[s]&&this._brokerConnection[s](e))},t.prototype._removeSubscription=function(t,e,o){var r,i,n;void 0!==this._subscriptions[e]&&((i=(r=Object(h.ensure)(this._subscriptions[e]))[t].indexOf(o))>-1&&r[t].splice(i,1),0===r[t].length&&(n="unsubscribe"+t,this._brokerConnection[n]&&this._brokerConnection[n](e)))},t.prototype._positions=function(){return this._positionsCache?this._positionsCache.getObjects():Promise.resolve([])},t.prototype._trades=function(){return this._tradesCache?this._tradesCache.getObjects():Promise.resolve([])},t.prototype._orders=function(){return this._ordersCache.getObjects()},
t.prototype._makeSureBrokerIsConnected=function(){Object(h.assert)(1===this.connectionStatus(),"Broker is not connected")},t}(),S=o("1rjR"),B=o("QBLL"),T=o("Pw9B"),E=o("C9TK"),j=o("hY0g"),I=o.n(j),D=o("Vdly"),A=o.n(D),M=o("jCNj"),N=o("zXvd"),U=o("cUJV"),L=o("5XxY"),R=o("IWXC"),x=Object(v.getLogger)("Trading.CredentialsWebStorage"),V=function(t){function e(){return t.call(this,localStorage)||this}return Object(l.__extends)(e,t),e}(F=function(){function t(t){this._storage=t}return t.prototype.setItem=function(t,e){try{var o=Object(_.isObject)(e)?JSON.stringify(e):String(e);this._storage.setItem(t,o)}catch(e){x.logError("Unable to save credentials using key "+t+": "+e.message)}},t.prototype.getItem=function(t,e){var o,r;if(void 0===e&&(e=null),o=e,null===(r=this._storage.getItem(t)))return o;try{o=JSON.parse(r)}catch(t){o=r}return o},t.prototype.removeItem=function(t){this._storage.removeItem(t)},t}()),q=function(t){function e(){return t.call(this,sessionStorage)||this}return Object(l.__extends)(e,t),e}(F),function(t){t[t.LocalStorage=0]="LocalStorage",t[t.SessionStorage=1]="SessionStorage"}(W||(W={})),Q=function(){function t(t,e){void 0===e&&(e=W.LocalStorage),this._brokerId=t.toLowerCase(),this._storageProvider=e===W.LocalStorage?new V:new q}return t.prototype.save=function(t,e){this._storageProvider.setItem(this._brokerId+"."+t,e)},t.prototype.load=function(t,e){return this._storageProvider.getItem(this._brokerId+"."+t,e)},t.prototype.clear=function(t){this._storageProvider.removeItem(this._brokerId+"."+t)},t}(),K=o("kcTO"),H=function(){function t(t,e){this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._trading=t,this._orderUpdateTimes={},this._metainfo=e,this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._defaultDropdownActions=!0,this._credentialsStorage=new Q(this._metainfo.id),this.floatingTradingPanelVisibility().subscribe(this._setDefaultDropdownActionsBound),this.orderPanelVisibility().subscribe(this._setDefaultDropdownActionsBound),this.domPanelVisibility().subscribe(this._setDefaultDropdownActionsBound),this._setDefaultDropdownActions()}return t.prototype.getLogger=function(){return Object(v.getLogger)("Trading."+this._metainfo.id)},t.prototype.translate=function(t){return t},t.prototype.setBrokerConnectionAdapter=function(t){this._adapter=t},t.prototype.patchConfig=function(t){this._adapter.patchConfig(t)},t.prototype.showOrderDialog=function(t,e){return this._trading.orderViewController().showOrderView(this._adapter,t,e)},t.prototype.showPositionBracketsDialog=function(t,e,o){return this._trading.orderViewController().showPositionView(this._adapter,t,e,o)},t.prototype.showCancelOrderDialog=function(t,e){var o=this;return S.a.get().open(t).then(function(t){t&&o._adapter.processErrors(e(),!0,$.t("Failed to cancel order"))})},t.prototype.showCancelMultipleOrdersDialog=function(t,e,o,r){var i=this;return S.a.get().multiple(t,e,o).then(function(t){t&&i._adapter.processErrors(r(),!0,$.t("Failed to cancel one or more orders"))})},
t.prototype.showCancelBracketsDialog=function(t,e){var o=this;return B.a.get().open(t).then(function(t){t&&o._adapter.processErrors(e(),!0,$.t("Failed to cancel brackets"))})},t.prototype.showCancelMultipleBracketsDialog=function(t,e){var o=this;return B.a.get().multiple(t).then(function(t){t&&o._adapter.processErrors(e(),!0,$.t("Failed to cancel brackets"))})},t.prototype.showClosePositionDialog=function(t,e){return"object"==typeof t&&(t=t.id),Object(T.a)(t,this._trading.showErrorNotification,e)},t.prototype.showReversePositionDialog=function(t,e){return Object(E.a)(t,this._trading.showErrorNotification,e)},t.prototype.showMessageDialog=function(t,e){L.a.show(t,e)},t.prototype.setDurations=function(t){this._adapter.setDurations(t)},t.prototype.patchOrderDialogOptions=function(t){this._adapter.patchOrderDialogOptions(t)},t.prototype.patchPositionDialogOptions=function(t){this._adapter.patchPositionDialogOptions(t)},t.prototype.setSymbolSearchId=function(t){this._adapter.setSymbolSearchId(t)},t.prototype.activateBottomWidget=function(){return this._trading.toggleTradingWidget()},t.prototype.trackEvent=function(t,e,o){this._trading.trackEvent(t,e,o)},t.prototype.defaultFormatter=function(t,e){return Object(R.getQuoteSessionInstance)("simple").formatter(t,e)},t.prototype.numericFormatter=function(t){return Promise.resolve(new N.NumericFormatter(t))},t.prototype.quantityFormatter=function(t){return Promise.resolve(new U.QuantityFormatter(t))},t.prototype.selectBroker=function(){this._trading.selectBroker(null)},t.prototype.showTradingProperties=function(){this._trading.showTradingProperties()},t.prototype.symbolSnapshot=function(t){return Object(R.getQuoteSessionInstance)("full").snapshot(t)},t.prototype.suggestedQty=function(){return this._trading.suggestedQty()},t.prototype.silentOrdersPlacement=function(){return this._trading.noConfirmEnabled},t.prototype.floatingTradingPanelVisibility=function(){return this._trading.hideFloatingPanel.opposite()},t.prototype.domPanelVisibility=function(){return this._trading.domPanelVisibility()},t.prototype.orderPanelVisibility=function(){return this._trading.orderPanelVisibility()},t.prototype.showPricesWithZeroVolume=function(){return this._trading.showPricesWithZeroVolume},t.prototype.showNotification=function(t,e,o){void 0===o&&(o=0),0===o?this._trading.showErrorNotification(t,e):this._trading.showSuccessNotification(t,e)},t.prototype.connectionStatusUpdate=function(t,e){this._adapter.connectionStatusUpdate.fire(t,e),1===t&&this._setDefaultDropdownActions()},t.prototype.patchOrderUpdateTime=function(t){var e=this._orderUpdateTimes[t.id];return!e&&y.isOrderActive(t.status)&&(e=Date.now(),this._orderUpdateTimes[t.id]=e),void 0!==this._orderUpdateTimes[t.id]&&(t.updateTime=this._orderUpdateTimes[t.id]),t},t.prototype.orderUpdate=function(t,e){e&&!y.isOrderActive(t.status)||(this._orderUpdateTimes[t.id]=Date.now(),this.patchOrderUpdateTime(t)),this._adapter.onOrderUpdate(t,e)},t.prototype.positionUpdate=function(t,e){this._adapter.onPositionUpdate(t,e)},
t.prototype.tradeUpdate=function(t,e){this._adapter.onTradeUpdate(t,e)},t.prototype.orderPartialUpdate=function(t,e){Object(_.isObject)(t)&&this.patchOrderUpdateTime(t),this._adapter.onOrderPartialUpdate(t,e)},t.prototype.positionPartialUpdate=function(t,e){this._adapter.onPositionPartialUpdate(t,e)},t.prototype.tradePartialUpdate=function(t,e){this._adapter.onTradePartialUpdate(t,e)},t.prototype.executionUpdate=function(t){this._adapter.executionUpdate.fire(t)},t.prototype.fullUpdate=function(){this._adapter.onFullUpdate()},t.prototype.realtimeUpdate=function(t,e){this._adapter.fireSubscription("Realtime",t,e)},t.prototype.domeUpdate=function(t,e){this._adapter.fireSubscription("DOME",t,e)},t.prototype.pipValueUpdate=function(t,e){this._adapter.fireSubscription("PipValue",t,e)},t.prototype.plUpdate=function(t,e){this._adapter.fireSubscription("PL",t,e)},t.prototype.tradePLUpdate=function(t,e){this._adapter.fireSubscription("TradePL",t,e)},t.prototype.equityUpdate=function(t){this._adapter.fireSubscription("Equity","Equity",t)},t.prototype.marginAvailableUpdate=function(t){this._adapter.fireSubscription("MarginAvailable","MarginAvailable",t)},t.prototype.setButtonDropdownActions=function(t){this._defaultDropdownActions&&(this._defaultDropdownActions=!1,this.floatingTradingPanelVisibility().unsubscribe(this._setDefaultDropdownActionsBound),this.orderPanelVisibility().unsubscribe(this._setDefaultDropdownActionsBound),this.domPanelVisibility().unsubscribe(this._setDefaultDropdownActionsBound)),this._buttonDropdownActions=y.convertActionDescriptionsToPopupMenuDescriptions(t)},t.prototype.buttonDropdownActions=function(){return this._buttonDropdownActions},t.prototype.defaultContextMenuActions=function(){var t,e,o=[];for(e=0;e<arguments.length;e++)o[e]=arguments[e];return(t=this._trading).defaultContextMenuActions.apply(t,o)},t.prototype.defaultDropdownMenuActions=function(t){return this._trading.defaultDropdownMenuActions(t)},Object.defineProperty(t.prototype,"factory",{get:function(){return{createDelegate:function(){return new m.a},createWatchedValue:function(t){return new I.a(t)},createPriceFormatter:function(t,e,o,r){return new K.PriceFormatter(t,e,o,r)}}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"settings",{get:function(){var t=this,e=function(e,o){return A.a.setJSON(t._metainfo.id+"."+e,o)},o=function(e,o){return A.a.getJSON(t._metainfo.id+"."+e,o)},r=function(e,o){return A.a.remove(t._metainfo.id+"."+e,o)};return{save:e,load:o,clear:r}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"credentialsStorage",{get:function(){var t=this,e=function(e,o){return t._credentialsStorage.save(e,o)},o=function(e,o){return t._credentialsStorage.load(e,o)},r=function(e){return t._credentialsStorage.clear(e)};return{save:e,load:o,clear:r}},enumerable:!0,configurable:!0}),t.prototype.createMapper=function(t){return{tvToBroker:function(t){return t},brokerToTv:function(t){return t}}},t.prototype.createMapperSync=function(t,e){var o;return o=Promise.resolve(),{ready:function(){return o},
tvToBroker:function(t){return t},brokerToTv:function(t){return t}}},t.prototype.convertTimezone=function(t,e,o){var r=M.get_timezone(e),i=M.get_timezone(o),n=M.cal_to_utc(r,t);return M.utc_to_cal(i,n)},t.prototype.language=function(){return window.language},t.prototype.getUserSpecificHash=function(){return window.user.private_channel||""},t.prototype.activateFXCMCFD=function(t,e,o){checkFXCMCredentials(t,e,o)},t.prototype._setDefaultDropdownActions=function(){this._defaultDropdownActions&&(this._buttonDropdownActions=y.convertActionDescriptionsToPopupMenuDescriptions(this.defaultDropdownMenuActions()))},t}(),z=o("U/Is"),Y=o("E9hm"),o.d(e,"addBroker",function(){return c}),o.d(e,"brokersList",function(){return u}),o.d(e,"createBrokerConnection",function(){return d}),G=[]},Pw9B:function(t,e,o){"use strict";function r(t,e,o,r){return new Promise(function(n){var s=window.t("Close {0} position?").format(String(t)),a=r?window.t("Are you sure you want to close {positionId} position?{newLineAndBoldText}This will also close all active orders.{endBoldText}"):window.t("Are you sure you want to close {positionId} position?"),c="<p>"+a.format({positionId:t,newLineAndBoldText:"<br><b>",endBoldText:"</b>"})+"</p>",u=window.t("Close position"),d=window.t("Cancel");Object(i.a)(s,c,u,d).then(function(t){return!0===t?o():n(!1)}).then(function(){n(!0)}).catch(function(t){var o,r="";null!==t&&"object"==typeof t&&t.message?r=t.message:"string"==typeof t&&(r=t),o=window.t("Failed to close the position"),e(o,r),n(!1)})})}var i;o.d(e,"a",function(){return r}),o("HbRj"),o("YFKU"),i=o("hHwE")},QBLL:function(t,e,o){"use strict";var r,i;o.d(e,"a",function(){return i}),o("HbRj"),o("YFKU"),r=o("hHwE"),i={get:function(){return this},open:function(t){var e=window.t("Cancel Bracket"),o="<p>"+window.t("Are you sure you want to cancel {0}bracket?").format(t?t+" ":"")+"</p>";return Object(r.a)(e,o)},multiple:function(t){var e=window.t("Cancel Brackets"),o="<p>"+window.t("Are you sure you want to cancel {0}brackets?").format(t?t+" ":"")+"</p>";return Object(r.a)(e,o)}}},X8qL:function(t,e,o){"use strict"},hHwE:function(t,e,o){"use strict";function r(t,e,r,i){return new Promise(function(n,s){Promise.all([o.e("dialogs-core"),o.e("create-dialog")]).then(function(s){var a=o("YDhE").createDialog,c=a({title:t,content:e,width:500,type:"modal",closeOnOutsideClick:!1,draggable:!1,destroyOnClose:!0,addClass:"tv-text",actions:[{name:"no",text:i||window.t("No"),type:"default",method:"close"},{name:"yes",text:r||window.t("Yes"),type:"primary",method:"close",key:13}]});c.on("action:yes",function(){n(!0)}),c.on("destroy",function(){n(!1)}),c.open(),c.setZIndex(200)}.bind(null,o)).catch(o.oe)})}o.d(e,"a",function(){return r}),o("HbRj"),o("YFKU")},"pJ/4":function(t,e,o){"use strict"
;var r=o("OekH"),i=r.CONNECTSTATUSES,n=r.SIDE,s=r.ORDERTYPE,a=r.ORDERSTATUS,c=r.TICKETFOCUS,u=r.PARENTTYPE,d=o("kcTO").PriceFormatter,l=o("cUJV").QuantityFormatter,p=o("7KDR").Action,h=o("4qhP"),f=o("uOxu").getLogger("Trading.ChartWidgetController"),_=o("9XXR").splitThousands,b=o("Ialn"),m=o("Eyy1").ensureNotNull,y=o("8Wzo").StopType,g=function(t,e){this._chartModel=t,this._trading=e,this._updateExecutionsTimeout=null,this._positionProfitHandlerBinded=this._positionProfitHandler.bind(this),this._trading.onConnectionStatusChange.subscribe(this,this.onStatusChanged),this._formatter=new d,this._quantityFormatter=new l,this._ordersInModify={},this._tradesMode=!1,this._ordersMap={};var o=t.mainSeries();o.dataEvents().symbolResolved().subscribe(this,this.onSymbolChanged),o.dataEvents().symbolError().subscribe(this,this.onSymbolChanged),this.onStatusChanged(),this.onSymbolChanged()};g.prototype.destroy=function(){this.reset(),this._trading.onConnectionStatusChange.unsubscribe(this,this.onStatusChanged);var t=this._chartModel.mainSeries();t.dataEvents().symbolResolved().unsubscribe(this,this.onSymbolChanged),t.dataEvents().symbolError().unsubscribe(this,this.onSymbolChanged)},g.prototype.paneViews=function(t){return[]},g.prototype.priceAxisViews=function(t,e){return[]},g.prototype.updateAllViews=function(){},g.prototype.broker=function(){return this._trading.activeBroker()},g.prototype.removeObjects=function(){var t,e,o;for(t in this._executions)this._executions[t]._adapter.remove();for(e in this._orders)this._orders[e].mainTool._adapter.remove(),this._orders[e].addTool&&this._orders[e].addTool._adapter.remove();for(o in this._positions)this._positions[o]._adapter.remove(),this._tradesMode?this._broker.unsubscribeTradePL(o,this._positionProfitHandlerBinded):this._broker.unsubscribePL(o,this._positionProfitHandlerBinded);this._executions={},this._orders={},this._positions={}},g.prototype.updateAllWhenLoaded=function(){this._scheduledUpdate||(this._chartModel.mainSeries().data().isEmpty()?(this._scheduledUpdate=!0,this._chartModel.mainSeries().dataEvents().completed().subscribe(this,this.updateAll,!0)):this.updateAll())},g.prototype.updateAll=function(){var t=this;this._updateExecutionsTimeout&&clearTimeout(this._updateExecutionsTimeout),this.removeObjects(),this._scheduledUpdate=!1,this._symbol&&this._broker&&this._broker.connectionStatus()===i.CONNECTED&&((this._tradesMode?this._broker.trades(this._symbol):this._broker.positions(this._symbol)).then(function(e){e.forEach(function(e){t.onPositionUpdate(e)})}),this._broker.orders(this._symbol).then(function(e){e.forEach(function(e){t._ordersMap[e.id]=e}),e.forEach(function(e){t.onOrderUpdate(e)})}),this._broker.executions(this._symbol).then(function(e){var o=200;!function r(i){if(i>e.length)t._updateExecutionsTimeout=null;else{var n,s,a,c=i+o;n=e.slice(i,c),s=t._chartModel,(a=s.paneForSource(s.mainSeries())).beginInsertManyLineDataSources(),n.forEach(function(e){t.onExecutionUpdate(e)}),a.endInsertManyLineDataSources(),t._updateExecutionsTimeout=setTimeout(r.bind(null,c),1500)}
}(0)}))},g.prototype.onSymbolChanged=function(t){this._symbol=void 0!==t?t.pro_name||t.full_name:this._chartModel.mainSeries().proSymbol(),this._updateAll()},g.prototype._updateAll=function(){this.removeObjects(),this._symbol&&this._broker&&this._broker.connectionStatus()===i.CONNECTED&&(this.updateAllWhenLoaded(),this.updateFormatters())},g.prototype._computeTradesMode=function(){if(!this._broker)return!1;var t=this._broker.metainfo().configFlags;return!!t.supportTrades&&(!t.supportPositionBrackets&&!!t.supportCloseTrade)},g.prototype.updateFormatters=function(){var t,e,o;this._symbol&&this._broker&&(t=this,e=this._broker.formatter(this._symbol),o=this._broker.quantityFormatter(this._symbol),Promise.all([e,o]).then(function(e){t._formatter=e[0],t._quantityFormatter=e[1],t.updateAllWhenLoaded()}))},g.prototype.onStatusChanged=function(){var t=this._trading.activeBroker()&&this._trading.activeBroker().connectionStatus()===i.CONNECTED;this._broker===this._trading.activeBroker()&&t||(this._broker&&this.reset(),t&&(this._broker=this._trading.activeBroker(),this._broker.fullUpdate.subscribe(this,this._updateAll),this._tradesMode=this._computeTradesMode(),this._tradesMode?this._broker.tradeUpdate.subscribe(this,g.prototype.onPositionUpdate):this._broker.positionUpdate.subscribe(this,g.prototype.onPositionUpdate),this._broker.orderUpdate.subscribe(this,g.prototype.onOrderUpdate),this._broker.executionUpdate.subscribe(this,g.prototype.onExecutionUpdate),this.updateFormatters(),this._updateAll()))},g.prototype.reset=function(){this._updateExecutionsTimeout&&clearTimeout(this._updateExecutionsTimeout),this.removeObjects(),this._broker&&(this._broker.fullUpdate.unsubscribe(this,this._updateAll),this._tradesMode?this._broker.tradeUpdate.unsubscribe(this,g.prototype.onPositionUpdate):this._broker.positionUpdate.unsubscribe(this,g.prototype.onPositionUpdate),this._broker.orderUpdate.unsubscribe(this,g.prototype.onOrderUpdate),this._broker.executionUpdate.unsubscribe(this,g.prototype.onExecutionUpdate)),this._broker=null,this._formatter=new d},g.prototype.redraw=function(){var t=this._chartModel,e=t.paneForSource(t.mainSeries());t.updatePane(e)},g.prototype.profitState=function(t){var e=Math.round(100*t)/100;return e>0?"positive":e<0?"negative":"neutral"},g.prototype._positionProfitFormatter=function(t){return isNumber(t)?_((Math.round(100*t)/100||0).toFixed(2)," "):$.t("n/a")},g.prototype._positionProfitHandler=function(t,e){this._positions[t]._adapter.setText(b.startWithLTR(this._positionProfitFormatter(e))).setProfitState(this.profitState(e))},g.prototype.onPositionUpdate=function(t){var e,o,r,i,s,a,c,u,d;t.symbol===this._symbol&&(e=t.id,o="Chart Position",this._positions[e]&&(t.qty||(this._positions[e]._adapter.remove(),this._tradesMode?this._broker.unsubscribeTradePL(t.id,this._positionProfitHandlerBinded):this._broker.unsubscribePL(t.id,this._positionProfitHandlerBinded),delete this._positions[e])),f.logDebug("TRADING. Update position. Symbol:"+t.symbol+" , qty:"+t.qty),t.qty&&(r=this,i=function(e){
r._positions[t.id]&&e._adapter.unblock()},s=this._trading.activeBroker().metainfo().configFlags,a=this._tradesMode&&s.supportCloseTrade||!this._tradesMode&&s.supportClosePosition,this._positions[e]||(u=(c=this._chartModel).paneForSource(c.mainSeries()),(d=c.createLineTool(u,{price:Math.abs(this._tradesMode?t.price:t.avgPrice),index:0},"LineToolPosition")).position=t,a&&d._adapter.onClose(function(){r._trading.trackEvent(o,"Close Position"),d._adapter.block(),(r._tradesMode?m(r._trading.brokerCommandsUI()).closeTrade(t.id,!0):m(r._trading.brokerCommandsUI()).closePosition(t.id,!0)).then(function(){i(d)}).catch(function(){i(d)})}),!this._tradesMode&&s.supportReversePosition&&d._adapter.onReverse(function(){r._trading.trackEvent(o,"Reverse Position"),d._adapter.block(),m(r._trading.brokerCommandsUI()).reversePosition(t.id).then(function(){i(d)}).catch(function(){i(d)})}),this._positions[e]=d,this._tradesMode?this._broker.subscribeTradePL(t.id,this._positionProfitHandlerBinded):this._broker.subscribePL(t.id,this._positionProfitHandlerBinded)),Math.abs(t.qty)||f.logError("set position qty to 0!"),this._positions[e]._adapter.setPrice(Math.abs(this._tradesMode?t.price:t.avgPrice)).setQuantity(Math.abs(t.qty)*(t.side===n.BUY?1:-1)).setDirection(t.side===n.BUY?"buy":"sell").setCloseEnabled(!this._tradesMode||t.canBeClosed).onContextMenu(function(){var e,o,i,n=[],c="Chart Position Context Menu";return!r._tradesMode&&s.supportPositionBrackets?(e=new p({label:window.t("Protect Position..."),onExecute:function(){r._trading.trackEvent(c,"Edit Position"),m(r._trading.brokerCommandsUI()).editPositionBrackets(t.id)}}),n.push(e)):r._tradesMode&&s.supportTradeBrackets&&(e=new p({label:window.t("Protect Position..."),onExecute:function(){r._trading.trackEvent(c,"Edit Position"),m(r._trading.brokerCommandsUI()).editTradeBrackets(t.id)}}),n.push(e)),!a||r._tradesMode&&!t.canBeClosed||(o=new p({label:window.t("Close Position"),onExecute:function(){r._trading.trackEvent(c,"Close Position"),r._tradesMode?m(r._trading.brokerCommandsUI()).closeTrade(t.id):m(r._trading.brokerCommandsUI()).closePosition(t.id)}}),n.push(o)),!r._tradesMode&&s.supportReversePosition&&(i=new p({label:window.t("Reverse Position"),onExecute:function(){r._trading.trackEvent(c,"Reverse Position"),m(r._trading.brokerCommandsUI()).reversePosition(t.id)}}),n.push(i)),n}),!this._tradesMode&&s.supportPositionBrackets?this._positions[e]._adapter.onModify(function(){r._trading.trackEvent(o,"Edit Position"),m(r._trading.brokerCommandsUI()).editPositionBrackets(t.id)}):this._tradesMode&&s.supportTradeBrackets&&this._positions[e]._adapter.onModify(function(){r._trading.trackEvent(o,"Edit Position"),m(r._trading.brokerCommandsUI()).editTradeBrackets(t.id)}),this._positions[e].updateAllViews(),this.redraw()))},g.prototype.sideToText=h.sideToText,g.prototype.orderText=function(t){if(t.parentId){var e=this._ordersMap[t.parentId];if(t.parentType!==u.ORDER||e&&function(t,e){var o,r;if(t.side===e.side)return!1;if(o=t.limitPrice||t.stopPrice,r=e.limitPrice||e.stopPrice,t.side===n.BUY){
if(e.type===s.LIMIT&&r<o||e.type===s.STOP&&r>o)return!1}else if(e.type===s.LIMIT&&r>o||e.type===s.STOP&&r<o)return!1;return!0}(e,t)){if(t.type===s.STOP)return t.stopType===y.TrailingStop?$.t("TRAILING STOP"):$.t("STOP LOSS");if(t.type===s.LIMIT)return $.t("TAKE PROFIT")}}return(this.sideToText(t.side)+" "+h.orderTypeToText(t.type)).toUpperCase()},g.prototype.getNestedOrders=function(t){return this._broker.orders().then(function(e){var o,r=e.find(function(e){return e.id===t});return void 0===r?[]:r.parentId?(o=e.find(function(t){return t.id===r.parentId}),e.filter(function(t){return t.parentId===r.parentId}).concat(o)):e.filter(function(t){return t.parentId===r.id}).concat(r)}).then(function(t){return t.filter(Boolean).map(function(t){return t.id})})},g.prototype._performNestedOrdersOperation=function(t,e){this.getNestedOrders(t).then(function(t){t.forEach(function(t){this._orders[t]&&(this._orders[t].mainTool._adapter[e](),this._orders[t].addTool&&this._orders[t].addTool._adapter[e]())},this)}.bind(this))},g.prototype.blockNestedOrders=function(t){this._performNestedOrdersOperation(t,"block")},g.prototype.unblockNestedOrders=function(t){this._performNestedOrdersOperation(t,"unblock")},g.prototype.onOrderUpdate=function(t){var e,o,r,i,d,l,h,_,g,v,k,P,w;if(this._ordersMap[t.id]=t,this._ordersInModify[t.id])this._ordersInModify[t.id]=t;else if(t.symbol===this._symbol&&t.type!==s.MARKET)if(e=this,o=t.id,r="Chart Order",t.status!==a.WORKING&&t.status!==a.INACTIVE)this._orders[o]&&(this._orders[o].mainTool._adapter.remove(),this._orders[o].addTool&&this._orders[o].addTool._adapter.remove(),delete this._orders[o]);else{switch(i=0,t.type){case s.LIMIT:i=t.limitPrice;break;default:i=t.stopPrice}this._orders[o]||(l=(d=this._chartModel).paneForSource(d.mainSeries()),isNumber(i)||f.logError("order price is not defined"),h=d.createLineTool(l,{price:i,index:0},"LineToolOrder"),this._orders[o]={mainTool:h},t.type===s.STOPLIMIT&&(_=t.limitPrice,g=d.createLineTool(l,{price:_,index:0},"LineToolOrder"),this._orders[o].addTool=g)),this._orders[o].addTool&&t.type!==s.STOPLIMIT&&(this._orders[o].mainTool._adapter.remove(),this._orders[o].mainTool=this._orders[o].addTool,delete this._orders[o].addTool),v=function(o,r,i){var a,d,l;o.parentId&&o.stopType===y.TrailingStop&&(a=e._ordersMap[o.parentId]||e._positions[o.parentId].position,Promise.all([e.broker().symbolInfo(e._symbol),e.broker().quotesSnapshot(e._symbol)]).then(function(t){var e=t[0],r=t[1];d=o.parentType!==u.ORDER?a.side===n.BUY?r.bid:r.ask:a.type===s.STOP?a.stopPrice:a.limitPrice,o.trailingStopPips=((o.stopPrice||o.limitPrice)-d)/e.pipSize*(a.side===n.BUY?-1:1)})),i=i||{},e._ordersInModify[t.id]=t,e.blockNestedOrders(o.id),l=null,t.type!==s.STOPLIMIT||i.limitPrice||(l=c.STOPPRICE),t.type!==s.STOPLIMIT||i.stopPrice||(l=c.LIMITPRICE),m(e._trading.brokerCommandsUI()).modifyOrder(o,i.silent,l).catch(function(){}).then(function(){if(!1===e._orders.hasOwnProperty(o.id))e.redraw(),delete e._ordersInModify[t.id];else{e.unblockNestedOrders(o.id);var r=e._ordersInModify[t.id]
;delete e._ordersInModify[t.id],e.onOrderUpdate(r)}})},this._orders[o]&&(k=this._orders[o].mainTool._adapter,P=t.status!==a.WORKING,k.setPrice(i).setText(this.orderText(t)).setMode(t.type===s.LIMIT?"limit":t.type===s.STOP?"stop":"").setActive(!P).setDirection(t.side===n.BUY?"buy":"sell").setQuantity(b.forceLTRStr(this._quantityFormatter.format(t.qty-(t.filledQty||0)))).setEditable(!0).onMove(function(o){var i,n;e._trading.trackEvent(r,"Move Order"),i=TradingView.clone(t),n=k.getPrice(),i.stopPrice?i.stopPrice=n:i.limitPrice&&(i.limitPrice=n),v(i,k,{silent:!0,stopPrice:Boolean(i.stopPrice)})}).onContextMenu(function(){var o,r,i="Chart Order Context Menu",n=[];return e._trading.activeBroker().metainfo().configFlags.supportModifyOrder&&(o=new p({label:window.t("Modify Order..."),onExecute:function(){e._trading.trackEvent(i,"Edit Order"),v(t,k)}}),n.push(o)),r=new p({label:window.t("Cancel Order"),onExecute:function(){e._trading.trackEvent(i,"Cancel Order"),m(e._trading.brokerCommandsUI()).cancelOrder(t.id)}}),n.push(r),n}).onCancel(function(){e._trading.trackEvent(r,"Cancel Order"),m(e._trading.brokerCommandsUI()).cancelOrder(t.id)}),this._trading.activeBroker().metainfo().configFlags.supportModifyOrder&&k.onModify(function(){e._trading.trackEvent(r,"Edit Order"),v(t,k)}),this._orders[o].addTool&&(_=t.limitPrice,(w=this._orders[o].addTool._adapter).setPrice(_).setQuantity(t.qty).setEditable(!0).setText(this.orderText(t)).setMode(t.type===s.LIMIT?"limit":t.type===s.STOP?"stop":"").setActive(!0).setDirection(t.side===n.BUY?"buy":"sell").setQuantity(t.qty).onMove(function(o){e._trading.trackEvent(r,"Move Order");var i=TradingView.clone(t);i.limitPrice=w.getPrice(),v(i,w,{silent:!0,limitPrice:!0})}),this._trading.activeBroker().metainfo().configFlags.supportModifyOrder&&w.onModify(function(){e._trading.trackEvent(r,"Edit Order"),v(t,w,{limitPrice:!0})})))}},g.prototype.executionText=function(t){var e=this.sideToText(t.side)+" "+t.qty+" @ "+this._formatter.format(t.price);return e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase()},g.prototype.onExecutionUpdate=function(t){var e,o,r,i,s,a,c;t.symbol===this._symbol&&(e=t.id,o=Math.round(t.time.valueOf()/1e3),this._executions[e]||(i=(r=this._chartModel).paneForSource(r.mainSeries()),s=r.createLineTool(i,{price:t.price,index:void 0},"LineToolExecution"),this._executions[e]=s),a=this.executionText(t),(c=this._executions[e])._adapter.setTime(o),c._adapter.setPrice(t.price),c._adapter.setDirection(t.side===n.BUY?"buy":"sell"),c._adapter.setTooltip(a),c.updateAllViews(),this.redraw())},t.exports=g},vOQ2:function(t,e,o){"use strict";var r,i,n,s;o.d(e,"d",function(){return r}),o.d(e,"a",function(){return i}),o.d(e,"c",function(){return n}),o.d(e,"b",function(){return s}),function(t){t.DomPanel="domPanel",t.OrderPanel="orderPanel"}(r||(r={})),i=400,n=296,s=451}}]);